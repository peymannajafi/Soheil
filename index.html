<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Building Info</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <style>
        /* Basic styles and theme setup */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5; /* Material Design background color */
        }
        html[dir="rtl"] body {
            font-family: 'Vazirmatn', sans-serif;
        }
        .page {
            display: none; /* Hide all pages by default */
        }
        .page.active {
            display: block; /* Show active page */
        }

        /* Header and Navigation */
        nav {
            background-color: #1565c0; /* Material Blue 700 */
        }
        .nav-wrapper {
            display: flex;
            align-items: center;
        }
        .brand-logo {
            padding-left: 1rem;
            padding-right: 1rem;
            font-size: 1.5rem !important;
        }
        html[dir="rtl"] .brand-logo {
             padding-right: 1rem;
             padding-left: 1rem;
        }
        .header-actions-container {
            margin-left: auto;
            display: flex;
            align-items: center;
        }
        html[dir="rtl"] .header-actions-container {
             margin-right: auto;
             margin-left: 0;
        }
        .header-actions-container .btn-flat {
            color: white;
        }

        /* Custom styles for QR Scanner */
        #qr-reader-container {
            max-width: 500px;
            margin: 20px auto;
            border-radius: 8px;
            overflow: hidden;
            border: 4px solid #1565c0;
        }

        /* Form styling */
        .card-panel h3 {
            font-size: 1.2rem;
            font-weight: 500;
            color: #1565c0;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            margin-top: 0;
        }
        .input-field label {
            width: 100%; /* Fix for RTL label alignment */
        }
        .stepper-container {
            display: flex;
            align-items: center;
            margin-top: 1rem;
        }
        .stepper-container .btn {
            padding: 0 1rem;
        }
        .stepper-container input {
            text-align: center;
            border: none !important;
            box-shadow: none !important;
            width: 60px !important;
            margin: 0 0.5rem;
            height: 2.5rem !important;
            pointer-events: none;
        }

        /* Thumbnail styles */
        .thumbnail-container {
            position: relative;
        }
        .thumbnail-delete {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #ef5350; /* Red */
        }
        html[dir="rtl"] .thumbnail-delete {
            right: auto;
            left: -10px;
        }

        /* Form QR Code */
        #form-qr-code-container {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: white;
            padding: 8px;
            border-radius: 8px;
        }
        html[dir="rtl"] #form-qr-code-container {
             right: auto;
             left: 1rem;
        }

        /* Admin Page FAB */
        .fixed-action-btn {
            bottom: 24px;
            right: 24px;
        }
        html[dir="rtl"] .fixed-action-btn {
            right: auto;
            left: 24px;
        }

        /* Detail Page */
        #detail-content .card-panel {
            padding: 24px;
        }
        .detail-row-label {
            color: rgba(0,0,0,0.6);
            font-size: 0.9rem;
        }
        .detail-row-value {
            font-size: 1.2rem;
            margin-top: 4px;
            word-wrap: break-word;
        }
        .detail-row-link {
            font-size: 1.1rem;
            color: #1565c0;
        }

        /* Progress Bar */
        #save-progress-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            z-index: 10000;
            display: none;
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <nav>
                <div class="nav-wrapper">
                    <a href="#" id="back-button" class="left hide"><i class="material-icons">arrow_back</i></a>
                    <a id="header-title" href="#" class="brand-logo"></a>
                    <div class="header-actions-container">
                        <div id="header-actions"></div>
                        <a id="lang-switcher" class="waves-effect waves-light btn-flat"></a>
                    </div>
                </div>
            </nav>
        </header>

        <div id="save-progress-container" class="progress">
            <div class="indeterminate"></div>
        </div>

        <main class="container" style="padding-top: 20px;">
            <div id="page-home" class="page active">
                <div class="row" style="margin-top: 3rem;">
                    <div class="col s12 m8 offset-m2 l6 offset-l3 center-align">
                        <button data-target="page-scanner" class="nav-button btn-large waves-effect waves-light blue darken-3" style="width: 100%; margin-bottom: 1rem;">
                            <i class="material-icons left">qr_code_scanner</i>
                            <span data-lang="scan_qr"></span>
                        </button>
                        <button data-target="page-admin" class="nav-button btn-large waves-effect waves-light grey darken-3" style="width: 100%; margin-bottom: 2rem;">
                            <i class="material-icons left">admin_panel_settings</i>
                            <span data-lang="add_building"></span>
                        </button>
                        <div class="file-field input-field center-align">
                             <a href="#!" class="blue-text text-darken-3" data-lang="import_data_file"></a>
                             <input type="file" id="import-file" class="hidden" accept=".json,.csv,.xls,.xlsx">
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-admin" class="page">
                <div class="row">
                    <div class="col s12">
                        <div class="input-field" style="background-color: white; padding: 0 1rem; border-radius: 4px;">
                            <i class="material-icons prefix">search</i>
                            <input type="search" id="search-bar" autocomplete="off">
                            <label for="search-bar" data-lang-placeholder="search_placeholder"></label>
                        </div>
                    </div>
                </div>
                <div id="building-list" class="collection">
                    </div>
                <div id="empty-admin-state" class="center-align" style="margin-top: 4rem; display: none;">
                    <i class="material-icons large grey-text">apartment</i>
                    <h5 data-lang="no_buildings_found"></h5>
                    <p data-lang="click_plus_to_add" class="grey-text"></p>
                </div>
                <div class="fixed-action-btn">
                  <a id="add-building-btn" class="btn-floating btn-large red">
                    <i class="large material-icons">add</i>
                  </a>
                </div>
            </div>

            <div id="page-form" class="page relative">
                <div id="form-qr-code-container" class="hide-on-small-only"></div>
                <form id="building-form">
                    <input type="hidden" id="id">

                    <div class="card-panel">
                        <h3 data-lang="form_section_address"></h3>
                        <div class="row">
                            <div class="input-field col s12">
                                <input type="text" id="buildingName" required>
                                <label for="buildingName" data-lang="form_building_name"></label>
                            </div>
                            <div class="input-field col s12 m6">
                                <input type="text" id="address">
                                <label for="address" data-lang="form_street"></label>
                            </div>
                            <div class="input-field col s12 m6">
                                <input type="text" id="city">
                                <label for="city" data-lang="form_city"></label>
                            </div>
                            <div class="input-field col s12 m6">
                                <input type="text" id="stateProvince">
                                <label for="stateProvince" data-lang="form_state_province"></label>
                            </div>
                            <div class="input-field col s12 m6">
                                <input type="text" id="zipPostal">
                                <label for="zipPostal" data-lang="form_zip_postal"></label>
                            </div>
                             <div class="input-field col s12 m6">
                                <input type="text" id="country">
                                <label for="country" data-lang="form_country"></label>
                            </div>
                            <div class="input-field col s12 m6">
                                <input type="url" id="webpage" class="validate">
                                <label for="webpage" data-lang="form_webpage"></label>
                            </div>
                            <div class="col s12" style="margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1.5rem;">
                                <div class="row">
                                    <div class="input-field col s6">
                                         <input type="text" id="latitude" readonly>
                                         <label for="latitude" data-lang="form_latitude"></label>
                                    </div>
                                    <div class="input-field col s6">
                                         <input type="text" id="longitude" readonly>
                                         <label for="longitude" data-lang="form_longitude"></label>
                                    </div>
                                </div>
                                <button type="button" id="get-location-btn" class="btn waves-effect waves-light blue darken-3" style="width: 100%;">
                                    <i class="material-icons left">my_location</i><span data-lang="form_get_location"></span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card-panel">
                        <h3 data-lang="form_section_profile"></h3>
                        <div class="row">
                            <div class="input-field col s12">
                                <select id="buildingUseType">
                                    </select>
                                <label data-lang="form_property_type"></label>
                            </div>
                            <div class="input-field col s12 m6">
                                 <select id="yearBuilt">
                                    </select>
                                 <label data-lang="form_year_built"></label>
                            </div>
                            <div class="input-field col s12 m6">
                                <input type="number" id="squareFeet">
                                <label for="squareFeet" data-lang="form_sqm"></label>
                            </div>
                            <div class="col s12 m6">
                                 <label data-lang="form_bedrooms"></label>
                                 <div class="stepper-container">
                                    <button type="button" class="btn waves-effect waves-light grey stepper-btn" data-target="bedrooms" data-action="decrement">-</button>
                                    <input type="text" value="0" readonly>
                                    <button type="button" class="btn waves-effect waves-light grey stepper-btn" data-target="bedrooms" data-action="increment">+</button>
                                 </div>
                                 <input type="number" id="bedrooms" class="hide" value="0">
                            </div>
                             <div class="col s12 m6">
                                 <label data-lang="form_bathrooms"></label>
                                 <div class="stepper-container">
                                    <button type="button" class="btn waves-effect waves-light grey stepper-btn" data-target="bathrooms" data-action="decrement">-</button>
                                    <input type="text" value="0" readonly>
                                    <button type="button" class="btn waves-effect waves-light grey stepper-btn" data-target="bathrooms" data-action="increment">+</button>
                                 </div>
                                 <input type="number" id="bathrooms" class="hide" value="0">
                            </div>
                            <div class="col s12" style="margin-top: 2rem;">
                                <label>
                                    <input type="checkbox" id="garage" />
                                    <span data-lang="form_garage"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="card-panel">
                        <h3 data-lang="form_section_financials"></h3>
                        <div class="row">
                           <div class="input-field col s12 m6">
                                <input type="number" id="loanAmount">
                                <label for="loanAmount" data-lang="form_loan_amount"></label>
                                <span class="helper-text" id="loanAmount-formatted"></span>
                           </div>
                           <div class="input-field col s12 m6">
                                <input type="number" id="assessedValue">
                                <label for="assessedValue" data-lang="form_assessed_value"></label>
                                <span class="helper-text" id="assessedValue-formatted"></span>
                           </div>
                           <div class="input-field col s12 m6">
                                <input type="number" id="currentValue">
                                <label for="currentValue" data-lang="form_current_value"></label>
                                <span class="helper-text" id="currentValue-formatted"></span>
                           </div>
                           <div class="input-field col s12 m6">
                                <input type="number" id="downPayment">
                                <label for="downPayment" data-lang="form_down_payment"></label>
                                <span class="helper-text" id="downPayment-formatted"></span>
                           </div>
                           <div class="input-field col s12 m6">
                                <input type="number" id="monthlyMortgage">
                                <label for="monthlyMortgage" data-lang="form_monthly_mortgage"></label>
                                <span class="helper-text" id="monthlyMortgage-formatted"></span>
                           </div>
                           <div class="input-field col s12 m6">
                                <input type="number" id="housingDues">
                                <label for="housingDues" data-lang="form_housing_dues"></label>
                                <span class="helper-text" id="housingDues-formatted"></span>
                           </div>
                           <div class="input-field col s12 m6">
                                <input type="number" id="tax">
                                <label for="tax" data-lang="form_tax"></label>
                                <span class="helper-text" id="tax-formatted"></span>
                           </div>
                           <div class="input-field col s12 m6">
                                <input type="number" id="insurance">
                                <label for="insurance" data-lang="form_insurance"></label>
                                <span class="helper-text" id="insurance-formatted"></span>
                           </div>
                        </div>
                    </div>

                    <div class="card-panel">
                        <h3 data-lang="form_section_photos"></h3>
                        <p class="grey-text text-darken-1" data-lang="form_photos_note"></p>
                        <div class="row" style="margin-top: 2rem;">
                            <div class="col s6 center-align">
                                 <div class="file-field input-field">
                                  <a class="btn waves-effect waves-light grey darken-3">
                                    <i class="material-icons">photo_library</i>
                                  </a>
                                  <input type="file" id="photo-upload" accept="image/*" multiple>
                                </div>
                                <span data-lang="form_upload_gallery"></span>
                            </div>
                             <div class="col s6 center-align">
                                <div class="file-field input-field">
                                  <a class="btn waves-effect waves-light blue darken-3">
                                    <i class="material-icons">photo_camera</i>
                                  </a>
                                  <input type="file" id="photo-capture" accept="image/*" capture="environment">
                                </div>
                                <span data-lang="form_take_photo"></span>
                            </div>
                        </div>
                        <div id="photo-thumbnails" class="row" style="margin-top: 1rem;">
                            </div>
                    </div>

                    <div class="card-panel">
                        <h3 data-lang="form_section_notes"></h3>
                        <div class="input-field">
                            <textarea id="notes" class="materialize-textarea"></textarea>
                            <label for="notes" data-lang="form_section_notes"></label>
                        </div>
                    </div>
                </form>
            </div>

            <div id="page-detail" class="page">
                <div id="detail-content" class="row">
                    </div>
            </div>

            <div id="page-scanner" class="page">
                <div id="qr-reader-container">
                    <div id="qr-reader"></div>
                </div>
                <p class="center-align grey-text" data-lang="scan_instruction"></p>
            </div>

            <div id="page-settings" class="page">
                <div class="row">
                    <div class="col s12">
                        <h5><span data-lang="settings_import_title"></span></h5>
                        <div class="card-panel">
                             <div class="file-field input-field">
                                <a class="btn waves-effect waves-light blue darken-2">
                                    <span><span data-lang="settings_import_button"></span></span>
                                    <i class="material-icons right">file_upload</i>
                                </a>
                                <input type="file" id="import-file-settings" accept=".json,.csv,.xls,.xlsx">
                            </div>
                             <p class="grey-text" data-lang="settings_import_desc"></p>
                        </div>

                        <h5 style="margin-top: 2rem;"><span data-lang="settings_export_title"></span></h5>
                        <div class="collection">
                            <a href="#!" id="export-json" class="collection-item waves-effect">
                                <div><b data-lang="settings_export_json"></b><i class="material-icons secondary-content">file_download</i></div>
                                <span class="grey-text" data-lang="settings_export_json_desc"></span>
                            </a>
                            <a href="#!" id="export-csv" class="collection-item waves-effect">
                                <div><b data-lang="settings_export_csv"></b><i class="material-icons secondary-content">file_download</i></div>
                                <span class="grey-text" data-lang="settings_export_csv_desc"></span>
                            </a>
                             <a href="#!" id="export-xlsx" class="collection-item waves-effect">
                                <div><b data-lang="settings_export_xlsx"></b><i class="material-icons secondary-content">file_download</i></div>
                                <span class="grey-text" data-lang="settings_export_xlsx_desc"></span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- APPLICATION LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- MATERIALIZE INITIALIZATION ---
            const M_instances = {
                selects: null,
                fab: null
            };
            const M_init = () => {
                const selectElems = document.querySelectorAll('select');
                M_instances.selects = M.FormSelect.init(selectElems);

                const fabElem = document.querySelector('.fixed-action-btn');
                if (fabElem) M_instances.fab = M.FloatingActionButton.init(fabElem);

                M.updateTextFields();
            };

            // --- STATE & CONFIG ---
            const DB_KEY = 'qrBuildingApp_buildings';
            const LANG_KEY = 'qrBuildingApp_lang';
            const state = {
                currentPage: 'page-home',
                history: [],
                activeScanner: null,
                photoCache: [],
                currentLang: localStorage.getItem(LANG_KEY) || 'en',
                isNewFormEntry: false,
                photosLoading: 0
            };

            // --- TRANSLATIONS (Identical to original script) ---
            const translations = {
                en: {
                    app_title: "Building Information Hub", admin_title: "Admin: Records", add_building_title: "Add Building", edit_building_title: "Edit Building", scan_title: "Scan QR Code", settings_title: "Settings & Data", scan_qr: "Scan Building QR Code", add_building: "Add Building", import_data_file: "Import Building Data File (JSON, CSV, Excel)",
                    no_buildings_found: "No buildings found.", click_plus_to_add: "Click the '+' button to add one.",
                    search_placeholder: "Search by Zip Code...", no_search_results: "No buildings match your search.", try_different_search: "Try a different zip code.",
                    form_section_address: "Address & Basic Info", form_building_name: "Building Name / Profile Name *", form_street: "Street", form_city: "City", form_state_province: "State/Province", form_zip_postal: "Zip/Postal Code", form_country: "Country/Region", form_webpage: "Web Page",
                    form_section_profile: "Property Profile", form_property_type: "Property Type", form_year_built: "Year Built", form_sqm: "Square Meters (m²)", form_bedrooms: "Bedrooms", form_bathrooms: "Bathrooms", form_garage: "Has a Garage",
                    form_eu_select: 'Select a classification...', form_eu_111: 'Residential - One-dwelling', form_eu_112: 'Residential - Multi-dwelling', form_eu_122: 'Commercial - Office Building', form_eu_123: 'Commercial - Wholesale and retail trade', form_eu_125: 'Commercial - Industrial and warehouse', form_eu_126: 'Public - Entertainment, education, hospital', form_eu_127: 'Other non-residential',
                    form_section_financials: "Financials", form_loan_amount: "Loan Amount", form_assessed_value: "Assessed Value", form_current_value: "Current Value", form_down_payment: "Down Payment", form_monthly_mortgage: "Monthly Mortgage", form_housing_dues: "Housing Dues", form_tax: "Tax", form_insurance: "Insurance",
                    form_section_location: "GPS Location", form_latitude: "Latitude", form_longitude: "Longitude", form_get_location: "Get Current Location",
                    form_section_photos: "Photos", form_photos_note: "Note: Storing many large photos may slow down the app. Storage is limited by your browser.", form_upload_gallery: "Upload from Gallery", form_take_photo: "Take Photo",
                    form_section_notes: "Notes",
                    scan_instruction: "Point your camera at a QR code. Accessing your camera is required.",
                    settings_import_title: "Import Data", settings_import_button: "Import from File", settings_import_desc: "Overwrite data from a JSON, CSV, or Excel file.",
                    settings_export_title: "Export Data", settings_export_json: "Export as JSON", settings_export_json_desc: "Best for backups and re-importing.", settings_export_csv: "Export as CSV", settings_export_csv_desc: "Good for spreadsheets.", settings_export_xlsx: "Export as Excel (XLSX)", settings_export_xlsx_desc: "Best for Excel users.",
                    confirm_delete: "Are you sure you want to delete this building?", confirm_import: "This will import {count} records and overwrite all existing data. Are you sure?",
                    toast_saved: "Building saved successfully!", toast_deleted: "Building deleted.", toast_no_data_export: "No data to export.", toast_exported: "Data exported as {format} successfully!", toast_imported: "{count} buildings imported successfully!", toast_import_fail: "Failed to import file. Make sure it's a valid and correctly formatted file.",
                    toast_location_captured: "Location captured!", toast_location_fail: "Could not get location. Please enable GPS.", toast_geo_unsupported: "Geolocation is not supported by your browser.",
                    toast_camera_fail: "Could not start camera. Please grant permission.", toast_qr_not_found: "Building not found in local data.", toast_fill_fields: "Please fill in all required fields.",
                    toast_photo_loading: "Please wait for photos to finish loading.", toast_photo_fail: "Failed to load photo. Please try again.",
                    yes: "Yes", no: "No", cancel: "Cancel", done: "Done", detail_full_address: "Full Address", detail_other_info: "Other Information", detail_open_maps: "Open in Google Maps", detail_qr_code: "Building QR Code", detail_download_qr: "Download QR Code"
                },
                fa: {
                    app_title: "مرکز اطلاعات ساختمان", admin_title: "مدیریت: رکوردها", add_building_title: "افزودن ساختمان", edit_building_title: "ویرایش ساختمان", scan_title: "اسکن کد QR", settings_title: "تنظیمات و داده‌ها",
                    scan_qr: "اسکن کد QR ساختمان", add_building: "افزودن ساختمان", import_data_file: "ورود اطلاعات از فایل (JSON, CSV, Excel)",
                    no_buildings_found: "هیچ ساختمانی یافت نشد.", click_plus_to_add: "برای افزودن، روی دکمه '+' کلیک کنید.",
                    search_placeholder: "جستجو بر اساس کد پستی...", no_search_results: "هیچ ساختمانی با جستجوی شما مطابقت ندارد.", try_different_search: "یک کد پستی دیگر را امتحان کنید.",
                    form_section_address: "آدرس و اطلاعات اولیه", form_building_name: "نام ساختمان / نام پروفایل *", form_street: "خیابان", form_city: "شهر", form_state_province: "استان/ایالت", form_zip_postal: "کد پستی", form_country: "کشور", form_webpage: "صفحه وب",
                    form_section_profile: "مشخصات ملک", form_property_type: "نوع ملک (طبقه‌بندی EU)", form_year_built: "سال ساخت", form_sqm: "متر مربع (m²)", form_bedrooms: "اتاق خواب", form_bathrooms: "حمام", form_garage: "دارای پارکینگ",
                    form_eu_select: 'یک طبقه‌بندی انتخاب کنید...', form_eu_111: 'مسکونی - یک واحدی', form_eu_112: 'مسکونی - چند واحدی', form_eu_122: 'تجاری - اداری', form_eu_123: 'تجاری - عمده و خرده فروشی', form_eu_125: 'صنعتی و انبار', form_eu_126: 'عمومی - تفریحی، آموزشی، بیمارستانی', form_eu_127: 'سایر غیرمسکونی‌ها',
                    form_section_financials: "اطلاعات مالی", form_loan_amount: "مبلغ وام", form_assessed_value: "ارزش ارزیابی شده", form_current_value: "ارزش فعلی", form_down_payment: "پیش پرداخت", form_monthly_mortgage: "قسط ماهانه", form_housing_dues: "شارژ ساختمان", form_tax: "مالیات", form_insurance: "بیمه",
                    form_section_location: "موقعیت GPS", form_latitude: "عرض جغرافیایی", form_longitude: "طول جغرافیایی", form_get_location: "دریافت موقعیت مکانی فعلی",
                    form_section_photos: "عکس‌ها", form_photos_note: "توجه: ذخیره عکس‌های زیاد و بزرگ ممکن است سرعت برنامه را کاهش دهد. فضای ذخیره‌سازی توسط مرورگر شما محدود است.", form_upload_gallery: "آپلود از گالری", form_take_photo: "گرفتن عکس",
                    form_section_notes: "یادداشت‌ها",
                    scan_instruction: "دوربین خود را به سمت کد QR بگیرید. دسترسی به دوربین الزامی است.",
                    settings_import_title: "ورود داده", settings_import_button: "ورود از فایل", settings_import_desc: "بازنویسی داده‌ها از فایل JSON، CSV یا Excel.",
                    settings_export_title: "خروج داده", settings_export_json: "خروجی به صورت JSON", settings_export_json_desc: "بهترین گزینه برای پشتیبان‌گیری و ورود مجدد.", settings_export_csv: "خروجی به صورت CSV", settings_export_csv_desc: "مناسب برای صفحات گسترده.", settings_export_xlsx: "خروجی به صورت Excel (XLSX)", settings_export_xlsx_desc: "بهترین گزینه برای کاربران اکسل.",
                    confirm_delete: "آیا از حذف این ساختمان مطمئن هستید؟", confirm_import: "این عملیات {count} رکورد را وارد کرده و تمام داده‌های موجود را بازنویسی می‌کند. آیا مطمئن هستید؟",
                    toast_saved: "ساختمان با موفقیت ذخیره شد!", toast_deleted: "ساختمان حذف شد.", toast_no_data_export: "داده‌ای برای خروج وجود ندارد.", toast_exported: "داده‌ها با موفقیت به صورت {format} خروجی گرفته شد!", toast_imported: "{count} ساختمان با موفقیت وارد شد!", toast_import_fail: "ورود فایل ناموفق بود. از معتبر و صحیح بودن فرمت فایل اطمینان حاصل کنید.",
                    toast_location_captured: "موقعیت مکانی ثبت شد!", toast_location_fail: "دریافت موقعیت مکانی ناموفق بود. لطفاً GPS را فعال کنید.", toast_geo_unsupported: "مرورگر شما از موقعیت‌یابی جغرافیایی پشتیبانی نمی‌کند.",
                    toast_camera_fail: "دوربین فعال نشد. لطفاً دسترسی را مجاز کنید.", toast_qr_not_found: "ساختمان در داده‌های محلی یافت نشد.", toast_fill_fields: "لطفاً تمام فیلدهای الزامی را پر کنید.",
                    toast_photo_loading: "لطفاً منتظر بمانید تا بارگذاری عکس‌ها تمام شود.", toast_photo_fail: "بارگذاری عکس ناموفق بود. لطفاً دوباره تلاش کنید.",
                    yes: "بله", no: "خیر", cancel: "لغو", done: "تایید", detail_full_address: "آدرس کامل", detail_other_info: "سایر اطلاعات", detail_open_maps: "باز کردن در نقشه گوگل", detail_qr_code: "کد QR ساختمان", detail_download_qr: "دانلود کد QR"
                }
            };

            const translate = (key, params = {}) => {
                let text = translations[state.currentLang][key] || key;
                for (const param in params) {
                    text = text.replace(`{${param}}`, params[param]);
                }
                return text;
            };

            const formatCurrency = (number) => {
                if (isNaN(number) || number === '' || number === null) return '';
                const numericValue = Number(number);
                if (state.currentLang === 'fa') {
                    return new Intl.NumberFormat('fa-IR', { style: 'currency', currency: 'IRR', minimumFractionDigits: 0 }).format(numericValue);
                } else {
                    return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(numericValue);
                }
            };

            // --- DOM ELEMENTS ---
            const pages = document.querySelectorAll('.page');
            const headerTitle = document.getElementById('header-title');
            const backButton = document.getElementById('back-button');
            const headerActions = document.getElementById('header-actions');
            const buildingList = document.getElementById('building-list');
            const emptyAdminState = document.getElementById('empty-admin-state');
            const searchBar = document.getElementById('search-bar');
            const form = document.getElementById('building-form');
            const importFileInput = document.getElementById('import-file');
            const importFileInputSettings = document.getElementById('import-file-settings');
            const exportJsonButton = document.getElementById('export-json');
            const exportCsvButton = document.getElementById('export-csv');
            const exportXlsxButton = document.getElementById('export-xlsx');
            const getLocationBtn = document.getElementById('get-location-btn');
            const photoUploadInput = document.getElementById('photo-upload');
            const photoCaptureInput = document.getElementById('photo-capture');
            const saveProgressContainer = document.getElementById('save-progress-container');

            // --- DATA SANITIZATION (Identical to original script) ---
            const sanitizeBuilding = (buildingData) => {
                let garageValue = buildingData.garage;
                if(typeof garageValue === 'string') {
                    garageValue = ['true', 'yes', '1'].includes(garageValue.toLowerCase());
                }
                return {
                    id: buildingData.id || db.uuid(),
                    buildingName: buildingData.buildingName || '',
                    address: buildingData.address || '',
                    city: buildingData.city || '',
                    stateProvince: buildingData.stateProvince || '',
                    zipPostal: buildingData.zipPostal || '',
                    country: buildingData.country || '',
                    webpage: buildingData.webpage || '',
                    yearBuilt: buildingData.yearBuilt || '',
                    buildingUseType: buildingData.buildingUseType || '',
                    loanAmount: buildingData.loanAmount || '',
                    assessedValue: buildingData.assessedValue || '',
                    currentValue: buildingData.currentValue || '',
                    squareFeet: buildingData.squareFeet || '',
                    bedrooms: buildingData.bedrooms || '0',
                    bathrooms: buildingData.bathrooms || '0',
                    garage: garageValue,
                    monthlyMortgage: buildingData.monthlyMortgage || '',
                    housingDues: buildingData.housingDues || '',
                    tax: buildingData.tax || '',
                    insurance: buildingData.insurance || '',
                    downPayment: buildingData.downPayment || '',
                    latitude: buildingData.latitude || '',
                    longitude: buildingData.longitude || '',
                    ownerName: buildingData.ownerName || '',
                    notes: buildingData.notes || '',
                    photos: buildingData.photos && Array.isArray(buildingData.photos) ? buildingData.photos : [],
                };
            };

            // --- DATABASE LOGIC (Identical to original script) ---
            const db = {
                uuid: () => {
                    const buildings = db.getAll();
                    if (buildings.length === 0) return 1;
                    return Math.max(...buildings.map(b => Number(b.id) || 0)) + 1;
                },
                getAll: () => JSON.parse(localStorage.getItem(DB_KEY) || '[]'),
                getById: (id) => db.getAll().find(b => String(b.id) === String(id)),
                save: (buildingData) => {
                    const buildings = db.getAll();
                    const buildingToSave = sanitizeBuilding(buildingData);
                    const index = buildings.findIndex(b => String(b.id) === String(buildingToSave.id));
                    if (index > -1) {
                        buildings[index] = buildingToSave;
                    } else {
                        buildings.push(buildingToSave);
                    }
                    localStorage.setItem(DB_KEY, JSON.stringify(buildings));
                },
                delete: (id) => {
                    let buildings = db.getAll();
                    buildings = buildings.filter(b => String(b.id) !== String(id));
                    localStorage.setItem(DB_KEY, JSON.stringify(buildings));
                },
                clear: () => localStorage.removeItem(DB_KEY)
            };

            // --- UI RENDERING & TRANSLATION ---
            const ui = {
                updateText: () => {
                    document.documentElement.lang = state.currentLang;
                    document.documentElement.dir = state.currentLang === 'fa' ? 'rtl' : 'ltr';
                    document.getElementById('lang-switcher').textContent = state.currentLang === 'en' ? 'FA' : 'EN';
                    
                    document.querySelectorAll('[data-lang]').forEach(el => {
                        const key = el.dataset.lang;
                        if (key) el.textContent = translate(key);
                    });

                     document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                        const key = el.dataset.langPlaceholder;
                        if (key) el.setAttribute('placeholder', translate(key));
                    });

                    // Populate Selects
                    const propertyTypeSelect = document.getElementById('buildingUseType');
                    const currentPropValue = propertyTypeSelect.value;
                    propertyTypeSelect.innerHTML = `
                        <option value="" disabled selected>${translate('form_eu_select')}</option>
                        <option value="${translate('form_eu_111')}">${translate('form_eu_111')}</option>
                        <option value="${translate('form_eu_112')}">${translate('form_eu_112')}</option>
                        <option value="${translate('form_eu_122')}">${translate('form_eu_122')}</option>
                        <option value="${translate('form_eu_123')}">${translate('form_eu_123')}</option>
                        <option value="${translate('form_eu_125')}">${translate('form_eu_125')}</option>
                        <option value="${translate('form_eu_126')}">${translate('form_eu_126')}</option>
                        <option value="${translate('form_eu_127')}">${translate('form_eu_127')}</option>
                    `;
                    propertyTypeSelect.value = currentPropValue;

                    const yearBuiltSelect = document.getElementById('yearBuilt');
                    const currentYearValue = yearBuiltSelect.value;
                    const currentYear = new Date().getFullYear();
                    let yearOptions = `<option value="" disabled selected>${translate('form_year_built')}</option>`;
                    for (let y = currentYear; y >= 1900; y--) {
                        yearOptions += `<option value="${y}">${y}</option>`;
                    }
                    yearBuiltSelect.innerHTML = yearOptions;
                    yearBuiltSelect.value = currentYearValue;
                },

                renderAdminList: (searchTerm = '') => {
                    let buildings = db.getAll();
                    const normalizedSearchTerm = searchTerm.toLowerCase().trim();

                    if (normalizedSearchTerm) {
                        buildings = buildings.filter(building =>
                            (building.buildingName && building.buildingName.toLowerCase().includes(normalizedSearchTerm)) ||
                            (building.address && building.address.toLowerCase().includes(normalizedSearchTerm)) ||
                            (building.zipPostal && building.zipPostal.toLowerCase().includes(normalizedSearchTerm))
                        );
                    }

                    buildingList.innerHTML = '';

                    if (buildings.length === 0) {
                        emptyAdminState.style.display = 'block';
                        const noBuildingsMsg = document.querySelector('#empty-admin-state h5');
                        const clickPlusMsg = document.querySelector('#empty-admin-state p');

                        if (normalizedSearchTerm) {
                            noBuildingsMsg.textContent = translate('no_search_results');
                            clickPlusMsg.textContent = translate('try_different_search');
                        } else {
                            noBuildingsMsg.textContent = translate('no_buildings_found');
                            clickPlusMsg.textContent = translate('click_plus_to_add');
                        }
                    } else {
                        emptyAdminState.style.display = 'none';
                        buildings.forEach(building => {
                            const item = document.createElement('a');
                            item.className = 'collection-item avatar waves-effect';
                            item.href = "#!";
                            item.dataset.id = building.id;
                            const zipBadge = building.zipPostal ? `<span class="badge blue white-text">${building.zipPostal}</span>` : '';
                            item.innerHTML = `
                                <i class="material-icons circle blue">apartment</i>
                                <span class="title"><b>${building.buildingName || 'Untitled'}</b></span>
                                <p>${building.address || 'No address'}<br>
                                   ${building.city || ''}
                                </p>
                                ${zipBadge}
                            `;
                            item.addEventListener('click', () => showPage('page-detail', { buildingId: building.id }));
                            buildingList.appendChild(item);
                        });
                    }
                },

                renderDetail: (building, isAdminView, isNewSave = false) => {
                    const content = document.getElementById('detail-content');
                    content.innerHTML = '';

                    const createSection = (titleKey, icon) => {
                         const section = document.createElement('div');
                         section.className = 'col s12';
                         let header = '';
                         if(titleKey) {
                            header = `<div class="card-panel"><h5 style="font-weight: 500;"><i class="material-icons left">${icon}</i> ${translate(titleKey)}</h5><div class="divider"></div><div class="section">`;
                         }
                         section.innerHTML = header + '</div></div>';
                         return section;
                    };
                    
                    const createFieldRow = (labelKey, value) => {
                        if (!value && value !== false && value !== 0) return '';
                        return `<div class="col s12 m6" style="margin-bottom: 1.5rem;">
                                    <div class="detail-row-label">${translate(labelKey)}</div>
                                    <div class="detail-row-value">${value}</div>
                                </div>`;
                    };

                    // Main Info
                    const mainInfoSection = document.createElement('div');
                    mainInfoSection.className = 'col s12';
                    const fullAddress = [building.address, building.city, building.stateProvince, building.zipPostal, building.country].filter(Boolean).join(', ');
                    let locationLink = '';
                    if (building.latitude && building.longitude) {
                        locationLink = `<a href="https://maps.google.com/?q=${building.latitude},${building.longitude}" target="_blank" class="detail-row-link">${translate('detail_open_maps')} <i class="material-icons tiny">open_in_new</i></a>`;
                    }
                     let webpageLink = '';
                    if (building.webpage) {
                        webpageLink = `<a href="${building.webpage}" target="_blank" class="detail-row-link">${building.webpage} <i class="material-icons tiny">open_in_new</i></a>`;
                    }
                    mainInfoSection.innerHTML = `
                        <div class="card-panel">
                            <h4 style="font-weight: 300;">${building.buildingName}</h4>
                            <p class="grey-text">${fullAddress}</p>
                            ${locationLink}
                            <div class="divider" style="margin: 1rem 0;"></div>
                            ${webpageLink}
                        </div>
                    `;
                    content.appendChild(mainInfoSection);

                    // Profile Section
                    let profileHtml = '';
                    profileHtml += createFieldRow('form_property_type', building.buildingUseType);
                    profileHtml += createFieldRow('form_year_built', building.yearBuilt);
                    profileHtml += createFieldRow('form_sqm', building.squareFeet);
                    profileHtml += createFieldRow('form_bedrooms', building.bedrooms);
                    profileHtml += createFieldRow('form_bathrooms', building.bathrooms);
                    profileHtml += createFieldRow('form_garage', building.garage ? translate('yes') : translate('no'));
                    if(profileHtml) {
                         const profileSection = createSection('form_section_profile', 'business');
                         profileSection.querySelector('.section').innerHTML = `<div class="row">${profileHtml}</div>`;
                         content.appendChild(profileSection);
                    }

                    // Financial Section
                    let financialHtml = '';
                    financialHtml += createFieldRow('form_loan_amount', formatCurrency(building.loanAmount));
                    financialHtml += createFieldRow('form_assessed_value', formatCurrency(building.assessedValue));
                    financialHtml += createFieldRow('form_current_value', formatCurrency(building.currentValue));
                    financialHtml += createFieldRow('form_down_payment', formatCurrency(building.downPayment));
                    financialHtml += createFieldRow('form_monthly_mortgage', formatCurrency(building.monthlyMortgage));
                    financialHtml += createFieldRow('form_housing_dues', formatCurrency(building.housingDues));
                    financialHtml += createFieldRow('form_tax', formatCurrency(building.tax));
                    financialHtml += createFieldRow('form_insurance', formatCurrency(building.insurance));
                     if(financialHtml) {
                         const financialSection = createSection('form_section_financials', 'account_balance_wallet');
                         financialSection.querySelector('.section').innerHTML = `<div class="row">${financialHtml}</div>`;
                         content.appendChild(financialSection);
                    }

                    // Notes
                    if(building.notes) {
                        const notesSection = createSection('form_section_notes', 'notes');
                        notesSection.querySelector('.section').innerHTML = `<p style="white-space: pre-wrap;">${building.notes}</p>`;
                        content.appendChild(notesSection);
                    }

                    // Photos
                    if (building.photos && building.photos.length > 0) {
                        const photoSection = createSection('form_section_photos', 'photo_camera');
                        const photoGrid = document.createElement('div');
                        photoGrid.className = 'row';
                        building.photos.forEach(photoSrc => {
                            photoGrid.innerHTML += `
                                <div class="col s6 m4 l3">
                                    <img src="${photoSrc}" class="materialboxed" width="100%" style="border-radius: 4px; margin-bottom: 1rem;">
                                </div>`;
                        });
                        photoSection.querySelector('.section').appendChild(photoGrid);
                        content.appendChild(photoSection);
                        const allPhotos = document.querySelectorAll('.materialboxed');
                        M.Materialbox.init(allPhotos);
                    }

                    // QR Code
                    if (isAdminView || isNewSave) {
                        const qrCard = document.createElement('div');
                        qrCard.className = 'col s12';
                        qrCard.innerHTML = `
                            <div id="qr-code-card" class="card-panel center-align">
                                <h5 style="font-weight: 500;">
                                    <i class="material-icons left">qr_code_2</i> ${translate('detail_qr_code')}
                                </h5>
                                <div id="detail-qr-code-container" style="margin: 1.5rem auto 0 auto; display: inline-block;"></div>
                                <div style="margin-top: 1.5rem;">
                                    <button id="detail-download-qr-button" class="btn waves-effect waves-light blue darken-3">
                                        <i class="material-icons left">download</i> ${translate('detail_download_qr')}
                                    </button>
                                </div>
                            </div>
                        `;
                        content.appendChild(qrCard);
                        const qrCode = new QRCodeStyling({ width: 250, height: 250, data: String(building.id), dotsOptions: { color: '#1565c0', type: 'rounded' }, backgroundOptions: { color: '#ffffff' }, cornersSquareOptions: { color: '#1e88e5', type: 'extra-rounded' }, cornersDotOptions: { color: '#1e88e5', type: 'dot' } });
                        qrCode.append(document.getElementById('detail-qr-code-container'));
                        document.getElementById('detail-download-qr-button').onclick = () => qrCode.download({ name: `qr-${building.buildingName.replace(/\s+/g, '-')}`, extension: 'png' });
                    }
                },

                renderPhotoThumbnails: () => {
                    const container = document.getElementById('photo-thumbnails');
                    container.innerHTML = '';
                    state.photoCache.forEach((photoSrc, index) => {
                        const thumbContainer = document.createElement('div');
                        thumbContainer.className = 'col s6 m4 l3 thumbnail-container';
                        
                        const img = document.createElement('img');
                        img.src = photoSrc;
                        img.className = 'responsive-img z-depth-1';
                        
                        const deleteBtn = document.createElement('a');
                        deleteBtn.className = 'btn-floating btn-small waves-effect waves-light red thumbnail-delete';
                        deleteBtn.innerHTML = '<i class="material-icons">close</i>';
                        deleteBtn.onclick = () => {
                            state.photoCache.splice(index, 1);
                            ui.renderPhotoThumbnails();
                        };
                        
                        thumbContainer.appendChild(img);
                        thumbContainer.appendChild(deleteBtn);
                        container.appendChild(thumbContainer);
                    });
                },

                renderFormQRCode: (id) => {
                    const container = document.getElementById('form-qr-code-container');
                    container.innerHTML = '';
                    const qrCode = new QRCodeStyling({ width: 100, height: 100, data: String(id), dotsOptions: { color: '#1565c0', type: 'rounded' }, backgroundOptions: { color: '#ffffff' } });
                    qrCode.append(container);
                },

                showToast: (messageKey, isError = false, params = {}) => {
                    const message = translate(messageKey, params);
                    const classes = isError ? 'red darken-1' : 'grey darken-4';
                    M.toast({html: message, classes: classes});
                }
            };

            // --- PAGE NAVIGATION & HEADER CONTROL ---
            const showPage = (pageId, params = {}, isGoingBack = false) => {
                if (state.activeScanner) { state.activeScanner.stop().catch(err => {}); state.activeScanner = null; }
                if (!isGoingBack && state.currentPage !== pageId) { state.history.push(state.currentPage); }
                
                state.currentPage = pageId;
                pages.forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                
                backButton.classList.toggle('hide', pageId === 'page-home');
                headerActions.innerHTML = '';

                let titleKey = 'app_title';
                switch (pageId) {
                    case 'page-admin':
                        titleKey = 'admin_title';
                        headerActions.innerHTML = `<a href="#!" id="settings-btn" class="waves-effect waves-light btn-flat"><i class="material-icons">settings</i></a>`;
                        document.getElementById('settings-btn').onclick = () => showPage('page-settings');
                        searchBar.value = '';
                        ui.renderAdminList();
                        break;

                    case 'page-form':
                        state.isNewFormEntry = !params.buildingId;
                        titleKey = state.isNewFormEntry ? 'add_building_title' : 'edit_building_title';
                        headerActions.innerHTML = `<a href="#!" id="save-btn" class="waves-effect waves-light btn-flat"><i class="material-icons">check</i></a>`;
                        document.getElementById('save-btn').onclick = handleFormSave;
                        form.reset();
                        state.photoCache = [];
                        let currentId;
                        
                        if (params.buildingId) {
                            const building = db.getById(params.buildingId);
                            if (building) {
                                currentId = building.id;
                                for (const key in building) {
                                    const element = document.getElementById(key);
                                    if (element) {
                                        if (element.type === 'checkbox') {
                                            element.checked = building[key];
                                        } else {
                                            element.value = building[key];
                                        }
                                    }
                                }
                                document.getElementById('id').value = building.id;
                                state.photoCache = [...(building.photos || [])];
                            }
                        } else {
                            currentId = db.uuid();
                            document.getElementById('id').value = currentId;
                        }

                        // Reset stepper displays
                         document.querySelectorAll('.stepper-container input').forEach(input => input.value = '0');
                         if(params.buildingId) {
                             const b = db.getById(params.buildingId);
                             document.querySelector('.stepper-btn[data-target="bedrooms"]').parentElement.querySelector('input').value = b.bedrooms || 0;
                             document.querySelector('.stepper-btn[data-target="bathrooms"]').parentElement.querySelector('input').value = b.bathrooms || 0;
                         }
                        
                        ui.renderFormQRCode(currentId);
                        ui.renderPhotoThumbnails();
                        M_init(); // Re-initialize selects
                        M.updateTextFields();
                        document.querySelectorAll('#building-form input[type="number"]').forEach(input => {
                            const formattedEl = document.getElementById(`${input.id}-formatted`);
                            if (formattedEl) {
                                formattedEl.textContent = formatCurrency(input.value);
                            }
                        });
                        break;

                    case 'page-detail':
                        const building = db.getById(params.buildingId);
                        if (building) {
                            headerTitle.textContent = building.buildingName;
                            const fromAdmin = state.history.at(-1) === 'page-admin';
                            if (fromAdmin || params.isNewSave) {
                                headerActions.innerHTML = `
                                    <a href="#!" id="edit-btn" class="waves-effect waves-light btn-flat"><i class="material-icons">edit</i></a>
                                    <a href="#!" id="delete-btn" class="waves-effect waves-light btn-flat"><i class="material-icons">delete</i></a>`;
                                document.getElementById('edit-btn').onclick = () => showPage('page-form', { buildingId: building.id });
                                document.getElementById('delete-btn').onclick = () => handleDelete(building.id);
                            }
                            ui.renderDetail(building, fromAdmin, params.isNewSave);
                            if (params.isNewSave) {
                                setTimeout(() => {
                                    const qrCard = document.getElementById('qr-code-card');
                                    if (qrCard) qrCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }, 100);
                            }
                        }
                        break;
                    
                    case 'page-scanner':
                        titleKey = 'scan_title';
                        startScanner();
                        break;
                    
                    case 'page-settings':
                        titleKey = 'settings_title';
                        break;
                }
                
                if (pageId !== 'page-detail') {
                    headerTitle.textContent = translate(titleKey);
                }
            };

            const goBack = () => { if (state.history.length > 0) { const pageToGoBackTo = state.history.pop(); showPage(pageToGoBackTo, {}, true); } };

            const handleFormSave = () => {
                if (state.photosLoading > 0) {
                    ui.showToast('toast_photo_loading', true);
                    return;
                }
                if (!form.checkValidity()) {
                    ui.showToast('toast_fill_fields', true);
                    form.reportValidity();
                    return;
                }
                
                saveProgressContainer.style.display = 'block';

                const buildingData = {};
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.id) {
                        if (input.type === 'checkbox') {
                            buildingData[input.id] = input.checked;
                        } else {
                            buildingData[input.id] = input.value;
                        }
                    }
                });
                buildingData.photos = state.photoCache;
                db.save(buildingData);
                ui.showToast('toast_saved');

                setTimeout(() => {
                    if (state.isNewFormEntry) {
                        showPage('page-detail', { buildingId: buildingData.id, isNewSave: true });
                    } else {
                        goBack();
                    }
                    saveProgressContainer.style.display = 'none';
                }, 500);
            };

            const handleDelete = (id) => { if (confirm(translate('confirm_delete'))) { db.delete(id); ui.showToast('toast_deleted'); goBack(); } };
            
            const startScanner = () => {
                const html5QrCode = new Html5Qrcode("qr-reader");
                state.activeScanner = html5QrCode;
                const onScanSuccess = (decodedText, decodedResult) => {
                    if (state.activeScanner) {
                        state.activeScanner.stop().then(ignore => {
                            const building = db.getById(decodedText);
                            if (building) {
                                state.history.push('page-home');
                                showPage('page-detail', { buildingId: building.id });
                            } else {
                                ui.showToast('toast_qr_not_found', true);
                                goBack();
                            }
                        }).catch(err => console.error("Failed to stop scanner", err));
                        state.activeScanner = null;
                    }
                };
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess).catch(err => ui.showToast("toast_camera_fail", true));
            };

            getLocationBtn.addEventListener('click', () => {
                if ('geolocation' in navigator) {
                    navigator.geolocation.getCurrentPosition(position => {
                        document.getElementById('latitude').value = position.coords.latitude.toFixed(6);
                        document.getElementById('longitude').value = position.coords.longitude.toFixed(6);
                        M.updateTextFields();
                        ui.showToast('toast_location_captured');
                    }, error => ui.showToast('toast_location_fail', true));
                } else { ui.showToast('toast_geo_unsupported', true); }
            });

            const handlePhotoFiles = (files, inputElement) => {
                if (!files || files.length === 0) {
                    if (inputElement) inputElement.value = null;
                    return;
                }
                const saveBtn = document.getElementById('save-btn');
                Array.from(files).forEach(file => {
                    state.photosLoading++;
                    if(saveBtn) saveBtn.classList.add('disabled');

                    const reader = new FileReader();
                    const doneLoading = () => {
                        state.photosLoading--;
                        if (state.photosLoading === 0 && saveBtn) {
                           saveBtn.classList.remove('disabled');
                        }
                    };
                    reader.onload = (e) => {
                        state.photoCache.push(e.target.result);
                        ui.renderPhotoThumbnails();
                        doneLoading();
                    };
                    reader.onerror = () => {
                        console.error("Error reading file.");
                        ui.showToast('toast_photo_fail', true);
                        doneLoading();
                    };
                    reader.readAsDataURL(file);
                });
                if (inputElement) inputElement.value = null;
            };
            
            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    let buildings = [];
                    try {
                        const fileExtension = file.name.split('.').pop().toLowerCase();
                        if (fileExtension === 'json') {
                            buildings = JSON.parse(e.target.result);
                        } else if (fileExtension === 'csv') {
                            buildings = Papa.parse(e.target.result, { header: true, skipEmptyLines: true }).data;
                        } else if (['xlsx', 'xls'].includes(fileExtension)) {
                            const workbook = XLSX.read(e.target.result, { type: 'binary' });
                            buildings = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        } else {
                            throw new Error('Unsupported file format.');
                        }
                        if (!Array.isArray(buildings)) throw new Error("Invalid file content.");
                        if (confirm(translate('confirm_import', { count: buildings.length }))) {
                            const sanitizedBuildings = buildings.map(b => sanitizeBuilding(b));
                            localStorage.setItem(DB_KEY, JSON.stringify(sanitizedBuildings));
                            ui.showToast('toast_imported', false, { count: sanitizedBuildings.length });
                            if (state.currentPage === 'page-admin') ui.renderAdminList(searchBar.value);
                            if (state.currentPage === 'page-home') goBack();
                        }
                    } catch (err) {
                        ui.showToast('toast_import_fail', true);
                        console.error(err);
                    }
                };
                reader.readAsBinaryString(file);
                event.target.value = null;
            };

            const createAndDownloadFile = (filename, content, type) => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(new Blob([content], { type }));
                link.download = filename;
                link.click();
                URL.revokeObjectURL(link.href);
            };

            const handleExport = (format) => {
                const buildings = db.getAll();
                if (buildings.length === 0) { ui.showToast("toast_no_data_export", true); return; }
                const cleanBuildings = buildings.map(b => {
                    const { photos, ...rest } = b;
                    return rest;
                });
                if (format === 'json') {
                    createAndDownloadFile('building_backup.json', JSON.stringify(buildings, null, 2), 'application/json');
                } else if (format === 'csv') {
                    createAndDownloadFile('building_backup.csv', Papa.unparse(cleanBuildings), 'text/csv;charset=utf-8;');
                } else if (format === 'xlsx') {
                    const worksheet = XLSX.utils.json_to_sheet(cleanBuildings);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Buildings");
                    XLSX.writeFile(workbook, "building_backup.xlsx");
                }
                ui.showToast('toast_exported', false, { format: format.toUpperCase() });
            };

            // --- EVENT LISTENERS ---
            backButton.addEventListener('click', goBack);
            document.querySelectorAll('.nav-button').forEach(btn => btn.addEventListener('click', () => showPage(btn.dataset.target)));
            document.getElementById('add-building-btn')?.addEventListener('click', () => showPage('page-form'));
            photoUploadInput.addEventListener('change', (e) => handlePhotoFiles(e.target.files, e.target));
            photoCaptureInput.addEventListener('change', (e) => handlePhotoFiles(e.target.files, e.target));

            document.querySelectorAll('.stepper-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetInput = document.getElementById(btn.dataset.target);
                    const stepperDisplay = btn.parentElement.querySelector('input[readonly]');
                    let currentValue = parseInt(targetInput.value, 10) || 0;
                    if (btn.dataset.action === 'increment') {
                        currentValue++;
                    } else if (currentValue > 0) {
                        currentValue--;
                    }
                    targetInput.value = currentValue;
                    stepperDisplay.value = currentValue;
                });
            });

            document.getElementById('lang-switcher').addEventListener('click', () => {
                state.currentLang = state.currentLang === 'en' ? 'fa' : 'en';
                localStorage.setItem(LANG_KEY, state.currentLang);
                ui.updateText();
                const currentBuildingId = document.getElementById('id')?.value;
                showPage(state.currentPage, { buildingId: currentBuildingId }, true); // Re-render current page
            });
            
            document.querySelectorAll('#building-form input[type="number"]').forEach(input => {
                const formattedEl = document.getElementById(`${input.id}-formatted`);
                if (formattedEl) {
                    input.addEventListener('input', () => {
                        formattedEl.textContent = formatCurrency(input.value);
                    });
                }
            });

            searchBar.addEventListener('input', (e) => {
                if (state.currentPage === 'page-admin') {
                    ui.renderAdminList(e.target.value);
                }
            });
            
            importFileInput.addEventListener('change', handleImport);
            importFileInputSettings.addEventListener('change', handleImport);
            exportJsonButton.addEventListener('click', () => handleExport('json'));
            exportCsvButton.addEventListener('click', () => handleExport('csv'));
            exportXlsxButton.addEventListener('click', () => handleExport('xlsx'));

            // --- INITIALIZATION ---
            ui.updateText();
            M_init();
            showPage('page-home');
        });
    </script>
</body>
</html>
