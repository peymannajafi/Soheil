<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building Information Hub</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Links -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100..900&display=swap" rel="stylesheet">

    <!-- JS Libraries -->
    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --primary-color: #4B0082;
            --primary-color-dark: #3a0069;
            --primary-color-light: #6c23b2;
            --background-color: #F7F7F5;
            --card-background-color: #FFFFFF;
            --text-color: #37352F;
            --text-color-light: #5E5C56;
            --border-color: #EAEAEA;
        }

        body {
            font-family: 'Ubuntu', sans-serif;
            color: var(--text-color);
            background-image: linear-gradient(to top, #f9fafb, #ffffff); /* Minimalist gradient */
        }
        html[dir="rtl"] body {
            font-family: 'Vazirmatn', sans-serif;
        }
        html[dir="rtl"] #back-button {
            transform: scaleX(-1);
        }
        .page { display: none; }
        .page.active { display: block; }
        
        header {
            background-color: var(--primary-color);
            color: #FFFFFF;
        }
        
        #header-title {
            font-weight: 400;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            border: 1px solid var(--border-color);
            background-color: var(--card-background-color);
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
            cursor: pointer;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
       
        .btn-primary {
            background-color: var(--primary-color);
            color: #FFFFFF;
            border-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: var(--primary-color-dark);
        }

        .btn-secondary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-secondary:hover {
            background-color: rgba(75, 0, 130, 0.05);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            background-color: #FFFFFF;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(75, 0, 130, 0.2);
        }
        
        #qr-reader-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-radius: 1rem;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .section-container {
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background-color: var(--card-background-color);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        
        #confirm-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        #confirm-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        #confirm-modal {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        /* Form section styling */
        .form-section-header {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .form-subsection-header {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="save-progress-bar" class="fixed top-0 left-0 h-1 bg-[var(--primary-color-light)] w-0 transition-all duration-500 z-[1001]"></div>

    <div id="app" class="max-w-4xl mx-auto">
        <header class="sticky top-0 z-50 shadow-md">
            <div class="mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg id="back-button" class="w-6 h-6 cursor-pointer hidden text-white hover:text-gray-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    <h1 id="header-title" class="text-xl"></h1>
                </div>
                 <div class="flex items-center space-x-4">
                    <div id="header-actions"></div>
                    <button id="lang-switcher" class="font-bold text-lg p-2 rounded-md hover:bg-black/20 w-12 text-center"></button>
                </div>
            </div>
        </header>

        <main class="p-4 md:p-6">
            <div id="page-home" class="page active">
                <div class="flex flex-col items-center justify-center h-[70vh] text-center space-y-6">
                    <h2 id="home-title" data-lang="app_title" class="text-4xl font-semibold text-[var(--text-color)] mb-8"></h2>
                    
                    <button data-target="page-admin" class="nav-button btn btn-primary w-full max-w-sm">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        <span data-lang="add_building"></span>
                    </button>
                    
                    <button data-target="page-scanner" class="nav-button btn btn-secondary w-full max-w-sm">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V6a2 2 0 012-2h2M4 16v2a2 2 0 002 2h2m8-12h2a2 2 0 012 2v2m-4 8h2a2 2 0 002-2v-2M7 12h10"></path></svg>
                        <span data-lang="scan_qr"></span>
                    </button>
                    
                    <button id="import-excel-btn" type="button" class="btn btn-secondary w-full max-w-sm">
                         <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span data-lang="import_from_excel"></span>
                    </button>
                    <input type="file" id="import-excel-input" class="hidden" accept=".xlsx, .xls">
                </div>
            </div>

            <div id="page-admin" class="page">
                <div class="mb-6 sticky top-[61px] py-3 z-10" style="background-color: var(--background-color);">
                    <div class="relative">
                        <input type="search" id="search-bar" class="form-input pl-10" autocomplete="off">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                    </div>
                </div>
                <div id="building-list" class="space-y-3"></div>
                <div id="empty-admin-state" class="text-center py-16 text-gray-500 hidden">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" /></svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900" data-lang="no_buildings_found"></h3>
                    <p class="mt-1 text-sm text-gray-500" data-lang="click_plus_to_add"></p>
                </div>
            </div>

            <div id="page-form" class="page relative">
                <form id="building-form" class="space-y-6">
                    <input type="hidden" id="id">

                     <!-- Meta Information -->
                    <div class="section-container">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div><label for="formVersion">Form Version:</label><input type="text" id="formVersion" value="1.0" class="form-input bg-gray-100" readonly></div>
                            <div><label for="lastUpdated">Last Updated:</label><input type="text" id="lastUpdated" class="form-input bg-gray-100" readonly></div>
                            <div><label for="completedBy">Completed By:</label><input type="text" id="completedBy" class="form-input"></div>
                        </div>
                    </div>

                    <!-- Section 1 -->
                    <div class="section-container">
                        <h3 class="form-section-header">Section 1: Core Building & Site Information</h3>
                        
                        <h4 class="form-subsection-header">1.1 Project Information</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="projectName">Project Name:</label><input type="text" id="projectName" class="form-input"></div>
                            <div><label for="projectNumber">Project Number:</label><input type="text" id="projectNumber" class="form-input"></div>
                            <div><label for="buildingName">Building Name:</label><input type="text" id="buildingName" required class="form-input"></div>
                            <div><label for="buildingStatus">Building Status:</label><select id="buildingStatus" class="form-select"><option>Proposed</option><option>In Design</option><option>Under Construction</option><option>Operational</option><option>Decommissioned</option></select></div>
                        </div>

                        <h4 class="form-subsection-header">1.2 Location & Site</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div><label for="buildingAddressStreet">Street:</label><input type="text" id="buildingAddressStreet" class="form-input"></div>
                             <div><label for="buildingAddressCity">City:</label><input type="text" id="buildingAddressCity" class="form-input"></div>
                             <div><label for="buildingAddressState">State/Province:</label><input type="text" id="buildingAddressState" class="form-input"></div>
                             <div><label for="buildingAddressPostal">Postal Code:</label><input type="text" id="buildingAddressPostal" class="form-input"></div>
                             <div><label for="buildingAddressCountry">Country:</label><input type="text" id="buildingAddressCountry" class="form-input"></div>
                             <div><label for="gpsLatitude">GPS Latitude:</label><input type="number" step="any" id="gpsLatitude" class="form-input"></div>
                             <div><label for="gpsLongitude">GPS Longitude:</label><input type="number" step="any" id="gpsLongitude" class="form-input"></div>
                             <div class="md:col-span-2"><button type="button" id="get-location-btn" class="btn btn-secondary w-full">Get Current Location</button></div>
                             <div class="md:col-span-2"><label for="legalPropertyDescription">Legal Property Description:</label><textarea id="legalPropertyDescription" rows="3" class="form-textarea"></textarea></div>
                             <div><label for="plotLotNumber">Plot/Lot Number:</label><input type="text" id="plotLotNumber" class="form-input"></div>
                        </div>
                        
                        <h4 class="form-subsection-header">1.3 General Building Data</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="primaryUse">Primary Use/Occupancy Type:</label><select id="primaryUse" class="form-select"><option>Commercial Office</option><option>Residential</option><option>Retail</option><option>Industrial</option><option>Healthcare</option><option>Education</option><option>Other</option></select></div>
                            <div><label for="grossFloorArea">Gross Floor Area (m²):</label><input type="number" id="grossFloorArea" class="form-input"></div>
                            <div><label for="floorsAboveGround">Floors (Above Ground):</label><input type="number" id="floorsAboveGround" class="form-input"></div>
                            <div><label for="floorsBelowGround">Floors (Below Ground):</label><input type="number" id="floorsBelowGround" class="form-input"></div>
                            <div><label for="constructionCompletionYear">Construction Completion Year:</label><input type="date" id="constructionCompletionYear" class="form-input"></div>
                            <div><label for="majorRenovationYear">Major Renovation Year:</label><input type="date" id="majorRenovationYear" class="form-input"></div>
                        </div>
                        
                        <h4 class="form-subsection-header">1.4 Key Documents</h4>
                         <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div><label for="sitePlanDrawing">Site Plan Drawing:</label><input type="file" id="sitePlanDrawing" class="form-input"></div>
                            <div><label for="occupancyPermit">Occupancy Permit:</label><input type="file" id="occupancyPermit" class="form-input"></div>
                            <div><label for="mainBuildingPhoto">Main Building Photo:</label><input type="file" id="mainBuildingPhoto" class="form-input" accept="image/*"></div>
                        </div>
                    </div>

                    <!-- Section 2: Design & As-Built Information -->
                    <div class="section-container">
                        <h3 class="form-section-header">Section 2: Design & As-Built Information</h3>
                        <h4 class="form-subsection-header">2.1 Architectural Data</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="architecturalModelLink">Link to 3D Architectural Model (BIM):</label><input type="url" id="architecturalModelLink" class="form-input"></div>
                            <div><label for="asBuiltArchitecturalDrawings">As-Built Architectural Drawings (2D):</label><input type="file" id="asBuiltArchitecturalDrawings" class="form-input" multiple></div>
                            <div><label for="roomSchedule">Master Room Schedule / Space List (.xlsx, .csv):</label><input type="file" id="roomSchedule" class="form-input" accept=".xlsx,.csv"></div>
                            <div><label for="finishesSchedule">Master Finishes & Materials Schedule (.pdf, .xlsx):</label><input type="file" id="finishesSchedule" class="form-input" accept=".pdf,.xlsx"></div>
                        </div>
                        <h4 class="form-subsection-header">2.2 Structural Data</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="structuralSystemType">Structural System Type:</label><input type="text" id="structuralSystemType" class="form-input" placeholder="e.g., Steel Frame, Reinforced Concrete"></div>
                            <div><label for="structuralModelLink">Link to 3D Structural Model (BIM):</label><input type="url" id="structuralModelLink" class="form-input"></div>
                            <div><label for="asBuiltStructuralDrawings">As-Built Structural Drawings (2D):</label><input type="file" id="asBuiltStructuralDrawings" class="form-input" multiple></div>
                            <div><label for="structuralMaterialSpecs">Structural Material Specifications:</label><input type="file" id="structuralMaterialSpecs" class="form-input"></div>
                            <div><label for="floorLoadingCapacity">Floor Loading Capacity (kg/m² or psf):</label><input type="text" id="floorLoadingCapacity" class="form-input"></div>
                        </div>
                         <h4 class="form-subsection-header">2.3 Mechanical, Electrical & Plumbing (MEP) Data</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="mepModelLink">Link to 3D MEP Model (BIM):</label><input type="url" id="mepModelLink" class="form-input"></div>
                            <div><label for="asBuiltMepDrawings">As-Built MEP Drawings (2D):</label><input type="file" id="asBuiltMepDrawings" class="form-input" multiple></div>
                            <div><label for="mepEquipmentSchedule">Master MEP Equipment Schedule (.xlsx, .csv):</label><input type="file" id="mepEquipmentSchedule" class="form-input" accept=".xlsx,.csv"></div>
                            <div><label for="electricalPanelSchedules">Electrical Panel Schedules:</label><input type="file" id="electricalPanelSchedules" class="form-input" multiple></div>
                            <div class="md:col-span-2"><label for="utilityShutoffLocations">Main Utility Shut-off Locations:</label><textarea id="utilityShutoffLocations" class="form-textarea" rows="3" placeholder="Describe locations for Water, Gas, Electricity..."></textarea></div>
                        </div>
                    </div>

                     <!-- Section 3: Construction & Handover Records -->
                    <div class="section-container">
                        <h3 class="form-section-header">Section 3: Construction & Handover Records</h3>
                        <h4 class="form-subsection-header">3.1 Key Construction Info</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="generalContractor">Original General Contractor:</label><input type="text" id="generalContractor" class="form-input"></div>
                            <div><label for="architectOfRecord">Original Architect of Record:</label><input type="text" id="architectOfRecord" class="form-input"></div>
                            <div><label for="structuralEngineer">Original Structural Engineer:</label><input type="text" id="structuralEngineer" class="form-input"></div>
                            <div><label for="mepEngineer">Original MEP Engineer:</label><input type="text" id="mepEngineer" class="form-input"></div>
                            <div><label for="constructionStartDate">Construction Start Date:</label><input type="date" id="constructionStartDate" class="form-input"></div>
                            <div><label for="officialHandoverDate">Official Handover Date:</label><input type="date" id="officialHandoverDate" class="form-input"></div>
                        </div>
                        <h4 class="form-subsection-header">3.2 Handover Documentation</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div><label for="commissioningReport">Final Commissioning Report:</label><input type="file" id="commissioningReport" class="form-input"></div>
                             <div><label for="changeOrdersLog">Log of Change Orders:</label><input type="file" id="changeOrdersLog" class="form-input"></div>
                             <div><label for="rfiLog">Log of RFIs:</label><input type="file" id="rfiLog" class="form-input"></div>
                             <div><label for="warrantyLog">Master Warranty Log (.xlsx, .csv):</label><input type="file" id="warrantyLog" class="form-input" accept=".xlsx,.csv"></div>
                        </div>
                    </div>

                    <div class="pt-6 flex justify-end items-center space-x-4">
                        <button type="button" id="form-cancel-btn" class="btn">Cancel</button>
                        <button type="button" id="form-save-btn" class="btn btn-primary">Save Building</button>
                    </div>
                </form>
            </div>


            <div id="page-detail" class="page space-y-6">
                <div class="section-container text-center">
                   <h2 id="detail-building-name" class="text-2xl md:text-3xl font-bold text-gray-900 mb-2"></h2>
                   <div id="detail-qr-code-container" class="mt-4 p-4 bg-white inline-block rounded-lg border border-gray-200 shadow-sm"></div>
                </div>
                <div id="detail-content" class="space-y-6"></div>
                <div class="mt-2 flex flex-wrap justify-center gap-4">
                    <button id="detail-download-qr-btn" class="btn"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span data-lang="download_qr_image"></span></button>
                    <button id="detail-export-excel-btn" class="btn"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span data-lang="export_to_excel"></span></button>
                    <button id="detail-export-pdf-btn" class="btn btn-primary"><svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span data-lang="export_to_pdf"></span></button>
                </div>
            </div>

            <div id="page-scanner" class="page">
                <div id="qr-reader-container"><div id="qr-reader"></div></div>
                <p class="text-center text-gray-500 mt-4" data-lang="scan_instruction"></p>
            </div>
        </main>
        
        <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white py-2 px-4 rounded-lg shadow-lg transition-transform duration-300 translate-y-20 opacity-0"><p id="toast-message"></p></div>

        <div id="confirm-modal-overlay">
            <div id="confirm-modal">
                <p id="confirm-modal-message" class="text-lg text-gray-800 mb-6"></p>
                <div class="flex justify-center space-x-4">
                    <button id="confirm-modal-no" class="btn w-28"></button>
                    <button id="confirm-modal-yes" class="btn btn-primary w-28"></button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const DB_NAME = 'BimHubDB';
            const DB_VERSION = 1;
            const STORE_NAME = 'buildings';
            const LANG_KEY = 'qrBuildingApp_lang';

            let db; // To hold the database instance

            const state = { currentPage: 'page-home', history: [], activeScanner: null, currentLang: localStorage.getItem(LANG_KEY) || 'en', isNewFormEntry: false, confirmCallback: null };

            const translations = {
                en: {
                    app_title: "Building Information Hub", admin_title: "Building Records", add_building_title: "Add New Building", edit_building_title: "Edit Building", scan_title: "Scan QR Code", save: "Save",
                    scan_qr: "Scan Building QR Code", add_building: "Add New Building",
                    import_from_excel: "Import from Excel",
                    no_buildings_found: "No buildings found.", click_plus_to_add: "Click the '+' button above to add one.",
                    search_placeholder: "Search by Name or ZIP Code...", no_search_results: "No buildings match your search.", try_different_search: "Try a different search term.",
                    generate_qr: "Generate QR & Save", scan_instruction: "Point your camera at a QR code.", confirm_delete: "Are you sure you want to delete this building?",
                    toast_saved: "Building saved successfully!", toast_deleted: "Building deleted.", toast_camera_fail: "Could not start camera. Please grant permission.", toast_qr_not_found: "Building not found in local data.", toast_fill_fields: "Please fill in all required fields.", 
                    toast_location_captured: "Location captured!", toast_location_fail: "Could not get location.", toast_geo_unsupported: "Geolocation is not supported by your browser.",
                    toast_db_error: "Database error. Please refresh the page.",
                    toast_imported: "{count} records imported successfully!", toast_import_error: "Failed to import records. Please check the file format.",
                    yes: "Yes", no: "No", cancel: "Cancel",
                    export_to_excel: "Export to Excel", export_to_pdf: "Download PDF", download_qr_image: "Download QR Image", toast_no_data_export: "No data to export.", toast_exported: "Data exported as {format} successfully!",
                },
                fa: {
                    app_title: "مرکز اطلاعات ساختمان", admin_title: "لیست ساختمان‌ها", add_building_title: "افزودن ساختمان جدید", edit_building_title: "ویرایش ساختمان", scan_title: "اسکن کد QR", save: "ذخیره",
                    scan_qr: "اسکن کد QR ساختمان", add_building: "افزودن ساختمان جدید",
                    import_from_excel: "ورود از اکسل",
                    no_buildings_found: "هیچ ساختمانی یافت نشد.", click_plus_to_add: "برای افزودن، روی دکمه '+' بالا کلیک کنید.",
                    search_placeholder: "جستجو بر اساس نام یا کد پستی...", no_search_results: "هیچ ساختمانی با جستجوی شما مطابقت ندارد.", try_different_search: "عبارت دیگری را امتحان کنید.",
                    generate_qr: "ساختن QR و ذخیره", scan_instruction: "دوربین خود را به سمت کد QR بگیرید.", confirm_delete: "آیا از حذف این ساختمان مطمئن هستید؟",
                    toast_saved: "ساختمان با موفقیت ذخیره شد!", toast_deleted: "ساختمان حذف شد.", toast_camera_fail: "دوربین فعال نشد. لطفاً دسترسی را مجاز کنید.", toast_qr_not_found: "ساختمان در داده‌های محلی یافت نشد.", toast_fill_fields: "لطفاً تمام فیلدهای الزامی را پر کنید.",
                    toast_location_captured: "موقعیت مکانی ثبت شد!", toast_location_fail: "دریافت موقعیت مکانی ناموفق بود.", toast_geo_unsupported: "موقعیت یابی توسط مرورگر شما پشتیبانی نمی‌شود.",
                    toast_db_error: "خطای پایگاه داده. لطفا صفحه را رفرش کنید.",
                    toast_imported: "{count} رکورد با موفقیت وارد شد!", toast_import_error: "وارد کردن رکوردها ناموفق بود. لطفاً فرمت فایل را بررسی کنید.",
                    yes: "بله", no: "خیر", cancel: "لغو",
                    export_to_excel: "خروجی اکسل", export_to_pdf: "دانلود PDF", download_qr_image: "دانلود تصویر QR", toast_no_data_export: "داده‌ای برای خروج وجود ندارد.", toast_exported: "داده‌ها با موفقیت به صورت {format} خروجی گرفته شد!",
                }
            };
            
            const translate = (key, params = {}, lang = state.currentLang) => { let text = (translations[lang] || translations.en)[key] || key; for(const param in params) { text = text.replace(`{${param}}`, params[param]); } return text; };
            const dom = { pages: document.querySelectorAll('.page'), headerTitle: document.getElementById('header-title'), backButton: document.getElementById('back-button'), headerActions: document.getElementById('header-actions'), buildingList: document.getElementById('building-list'), emptyAdminState: document.getElementById('empty-admin-state'), searchBar: document.getElementById('search-bar'), form: document.getElementById('building-form'), saveProgressBar: document.getElementById('save-progress-bar'), formSaveBtn: document.getElementById('form-save-btn'), formCancelBtn: document.getElementById('form-cancel-btn'), confirmModalOverlay: document.getElementById('confirm-modal-overlay'), importExcelBtn: document.getElementById('import-excel-btn'), importExcelInput: document.getElementById('import-excel-input') };
            
            // --- IndexedDB Functions ---
            function openDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onupgradeneeded = event => {
                        db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        }
                    };
                    request.onsuccess = event => {
                        db = event.target.result;
                        resolve(db);
                    };
                    request.onerror = event => {
                        console.error("IndexedDB error:", event.target.errorCode);
                        reject(event.target.error);
                    };
                });
            }

            const dbOp = {
                save: (data) => {
                    return new Promise((resolve, reject) => {
                        const transaction = db.transaction([STORE_NAME], 'readwrite');
                        const store = transaction.objectStore(STORE_NAME);
                        const request = store.put(data);
                        transaction.oncomplete = () => resolve(request.result);
                        transaction.onerror = (event) => reject(event.target.error);
                    });
                },
                getAll: () => {
                    return new Promise((resolve, reject) => {
                        const transaction = db.transaction([STORE_NAME], 'readonly');
                        const store = transaction.objectStore(STORE_NAME);
                        const request = store.getAll();
                        transaction.oncomplete = () => resolve(request.result);
                        transaction.onerror = (event) => reject(event.target.error);
                    });
                },
                getById: (id) => {
                     return new Promise((resolve, reject) => {
                        const transaction = db.transaction([STORE_NAME], 'readonly');
                        const store = transaction.objectStore(STORE_NAME);
                        const request = store.get(id);
                        transaction.oncomplete = () => resolve(request.result);
                        transaction.onerror = (event) => reject(event.target.error);
                    });
                },
                delete: (id) => {
                     return new Promise((resolve, reject) => {
                        const transaction = db.transaction([STORE_NAME], 'readwrite');
                        const store = transaction.objectStore(STORE_NAME);
                        const request = store.delete(id);
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = (event) => reject(event.target.error);
                    });
                }
            };
            
            const blobToDataURI = (blob) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = e => reject(e.target.error);
                    reader.readAsDataURL(blob);
                });
            }

            const ui = {
                updateText: () => {
                    document.documentElement.lang = state.currentLang;
                    document.documentElement.dir = state.currentLang === 'fa' ? 'rtl' : 'ltr';
                    document.getElementById('lang-switcher').textContent = state.currentLang === 'en' ? 'FA' : 'EN';
                    document.querySelectorAll('[data-lang]').forEach(el => { if (el.dataset.lang) el.textContent = translate(el.dataset.lang); });
                    dom.searchBar.placeholder = translate('search_placeholder');
                    document.getElementById('home-title').textContent = translate('app_title');
                },
                renderAdminList: async (term = '') => {
                    let buildings = await dbOp.getAll();
                    const normTerm = term.toLowerCase().trim();
                    if (normTerm) buildings = buildings.filter(b => (b.buildingName && b.buildingName.toLowerCase().includes(normTerm)) || (b.buildingAddressPostal && b.buildingAddressPostal.toLowerCase().includes(normTerm)));
                    dom.buildingList.innerHTML = '';
                    if (buildings.length === 0) {
                        dom.emptyAdminState.classList.remove('hidden');
                    } else {
                        dom.emptyAdminState.classList.add('hidden');
                        buildings.forEach(b => { 
                            const item = document.createElement('div'); 
                            item.className = 'bg-white p-4 rounded-md border border-gray-200 hover:border-[var(--primary-color)] hover:shadow-sm cursor-pointer flex justify-between items-center'; 
                            item.dataset.id = b.id; 
                            item.innerHTML = `<div><h3 class="font-bold text-lg">${b.buildingName}</h3><p class="text-gray-500">${b.buildingAddressStreet || 'No address'}</p></div><span class="text-gray-500">${b.buildingAddressPostal||''}</span>`; 
                            item.onclick = async () => await showPage('page-detail', { id: b.id }); 
                            dom.buildingList.appendChild(item); 
                        });
                    }
                },
                renderDetail: async (b) => {
                    document.getElementById('detail-building-name').textContent = b.buildingName;
                    const qrContainer = document.getElementById('detail-qr-code-container'); qrContainer.innerHTML = ''; 
                    new QRCodeStyling({ 
                        width: 180, 
                        height: 180, 
                        data: String(b.id), 
                        dotsOptions: { color: '#000000', type: 'square' },
                        backgroundOptions: { color: '#ffffff' }
                    }).append(qrContainer);

                    const content = document.getElementById('detail-content');
                    content.innerHTML = '';

                    const createDetailField = (label, value) => {
                        if (!value) return '';
                        // For file objects, display their name
                        if (typeof value === 'object' && value.name) {
                           value = value.name;
                        }
                        return `<div class="flex justify-between py-2 border-b"><p class="font-medium text-gray-600">${label}</p><p class="text-right text-gray-800 break-all">${value}</p></div>`;
                    };
                    
                    const createSection = (title, data) => {
                        const fieldsHtml = Object.entries(data)
                            .map(([label, value]) => createDetailField(label, value))
                            .join('');

                        if (fieldsHtml.trim() === '') return '';
                        
                        return `
                            <div class="section-container">
                                <h3 class="form-section-header">${title}</h3>
                                <div class="space-y-2">${fieldsHtml}</div>
                            </div>
                        `;
                    }
                    
                    let detailHtml = createSection('Core Information', {
                        'Project Name': b.projectName,
                        'Project Number': b.projectNumber,
                        'Building Status': b.buildingStatus,
                        'Address': `${b.buildingAddressStreet || ''}, ${b.buildingAddressCity || ''} ${b.buildingAddressState || ''} ${b.buildingAddressPostal || ''}`.trim(),
                        'Country': b.buildingAddressCountry,
                        'GPS': b.gpsLatitude && b.gpsLongitude ? `${b.gpsLatitude}, ${b.gpsLongitude}` : '',
                        'Primary Use': b.primaryUse,
                        'Gross Floor Area (m²)': b.grossFloorArea,
                        'Floors Above Ground': b.floorsAboveGround,
                        'Floors Below Ground': b.floorsBelowGround,
                        'Construction Year': b.constructionCompletionYear ? new Date(b.constructionCompletionYear).getFullYear() : '',
                        'Renovation Year': b.majorRenovationYear ? new Date(b.majorRenovationYear).getFullYear() : ''
                    });

                    detailHtml += createSection('Design & As-Built Information', {
                        'Architectural Model Link': b.architecturalModelLink,
                        'Structural System Type': b.structuralSystemType,
                        'Floor Loading Capacity': b.floorLoadingCapacity,
                        'MEP Model Link': b.mepModelLink,
                        'Utility Shut-off Locations': b.utilityShutoffLocations,
                    });

                     detailHtml += createSection('Construction & Handover', {
                        'General Contractor': b.generalContractor,
                        'Architect of Record': b.architectOfRecord,
                        'Structural Engineer': b.structuralEngineer,
                        'MEP Engineer': b.mepEngineer,
                        'Construction Start': b.constructionStartDate,
                        'Handover Date': b.officialHandoverDate
                    });

                    const documentFields = {
                        'Site Plan Drawing': b.sitePlanDrawing,
                        'Occupancy Permit': b.occupancyPermit,
                        'Main Building Photo': b.mainBuildingPhoto,
                        'As-Built Architectural Drawings': b.asBuiltArchitecturalDrawings,
                        'Room Schedule': b.roomSchedule,
                        'Finishes Schedule': b.finishesSchedule,
                        'As-Built Structural Drawings': b.asBuiltStructuralDrawings,
                        'Structural Material Specs': b.structuralMaterialSpecs,
                        'As-Built MEP Drawings': b.asBuiltMepDrawings,
                        'MEP Equipment Schedule': b.mepEquipmentSchedule,
                        'Electrical Panel Schedules': b.electricalPanelSchedules,
                        'Commissioning Report': b.commissioningReport,
                        'Log of Change Orders': b.changeOrdersLog,
                        'Log of RFIs': b.rfiLog,
                        'Master Warranty Log': b.warrantyLog
                    };

                    detailHtml += createSection('Attached Documents', documentFields);

                    content.innerHTML = detailHtml;
                },
                showToast: (key, isErr = false, params = {}) => {
                    const toast = document.getElementById('toast'); toast.querySelector('p').textContent = translate(key, params);
                    toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-transform duration-300 ${isErr?'bg-red-600':'bg-gray-800'}`;
                    requestAnimationFrame(()=>{toast.style.opacity='1';toast.style.transform='translateY(0)';}); setTimeout(()=>{toast.style.opacity='0';toast.style.transform='translateY(5rem)';}, 3000);
                },
                showConfirmModal: (key, cb) => {
                    document.getElementById('confirm-modal-message').textContent = translate(key);
                    document.getElementById('confirm-modal-yes').textContent = translate('yes');
                    document.getElementById('confirm-modal-no').textContent = translate('no');
                    dom.confirmModalOverlay.classList.add('visible'); state.confirmCallback = cb;
                },
                hideConfirmModal: () => { dom.confirmModalOverlay.classList.remove('visible'); state.confirmCallback = null; }
            };

            const showPage = async (pageId, params = {}, isGoingBack = false) => {
                window.scrollTo(0,0);
                if (state.activeScanner) { state.activeScanner.stop().catch(()=>{}); state.activeScanner = null; }
                if (!isGoingBack && state.currentPage !== pageId) { state.history.push({page: state.currentPage, id: dom.form.id.value}); }
                state.currentPage = pageId; dom.pages.forEach(p=>p.classList.remove('active')); document.getElementById(pageId).classList.add('active');
                dom.backButton.classList.toggle('hidden', state.history.length === 0); dom.headerActions.innerHTML = '';
                
                dom.headerTitle.textContent = ''; 

                switch(pageId) {
                    case 'page-home': dom.headerTitle.textContent = translate('app_title'); break;
                    case 'page-admin': 
                        dom.headerTitle.textContent = translate('admin_title');
                        dom.headerActions.innerHTML = `
                            <button id="export-all-btn" class="p-2 rounded-full text-white hover:bg-black/20" title="Export All to Excel">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            </button>
                            <button id="add-btn" class="p-2 rounded-full text-white hover:bg-black/20" title="Add New Building">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                            </button>
                        `; 
                        document.getElementById('export-all-btn').onclick = () => handleExport('xlsx');
                        document.getElementById('add-btn').onclick = () => showPage('page-form'); 
                        dom.searchBar.value = ''; 
                        await ui.renderAdminList(); 
                        break;
                    case 'page-form': 
                        state.isNewFormEntry=!params.id; 
                        dom.headerTitle.textContent = translate(state.isNewFormEntry?'add_building_title':'edit_building_title');
                        
                        if(params.id) {
                            const buildingData = await dbOp.getById(params.id);
                            if(buildingData) {
                                for (const key in buildingData) {
                                    const el = document.getElementById(key);
                                    if(el) {
                                        if(el.type !== 'file') {
                                           el.value = buildingData[key];
                                        }
                                    }
                                }
                            }
                        } else {
                           dom.form.reset();
                           document.getElementById('id').value = crypto.randomUUID();
                           document.getElementById('lastUpdated').value = new Date().toLocaleDateString();
                           document.getElementById('formVersion').value = "1.0";
                        }
                        break;
                    case 'page-detail': 
                        const b_detail = await dbOp.getById(params.id); 
                        if(b_detail) { 
                            dom.headerTitle.textContent = b_detail.buildingName; 
                            dom.headerActions.innerHTML=`<button id="edit-btn" class="p-2 rounded-full text-white hover:bg-black/20"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg></button><button id="del-btn" class="p-2 rounded-full text-white hover:bg-red-500/50"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`; 
                            document.getElementById('edit-btn').onclick=()=>showPage('page-form',{id:b_detail.id}); 
                            document.getElementById('del-btn').onclick=()=>handleDelete(b_detail.id); 
                        } 
                        break;
                    case 'page-scanner': 
                        dom.headerTitle.textContent = translate('scan_title');
                        break;
                }
                
                if (pageId === 'page-detail') {
                    const b_render = await dbOp.getById(params.id); 
                    if (b_render) { 
                        await ui.renderDetail(b_render); 
                        document.getElementById('detail-download-qr-btn').onclick=()=>downloadQrAsImage(b_render); 
                        document.getElementById('detail-export-excel-btn').onclick=async ()=>handleExport('xlsx', [await dbOp.getById(params.id)]); 
                        document.getElementById('detail-export-pdf-btn').onclick=()=>pdf.generate(b_render); 
                    } else { 
                        ui.showToast('toast_qr_not_found',true); 
                        goBack(); 
                    }
                } else if (pageId === 'page-scanner') { 
                    startScanner(); 
                }
            };

            const goBack = () => { if (state.history.length > 0) { const prev = state.history.pop(); showPage(prev.page, {id: prev.id}, true); } };
            const handleDelete = (id) => ui.showConfirmModal('confirm_delete', async () => { await dbOp.delete(id); ui.showToast('toast_deleted'); showPage('page-admin'); });

            const handleFormSave = async () => {
                if (!dom.form.checkValidity()) { ui.showToast('toast_fill_fields', true); dom.form.reportValidity(); return; }
                
                dom.formSaveBtn.disabled = true;
                dom.saveProgressBar.style.width='50%';

                const data={}; const inputs=dom.form.querySelectorAll('input,select,textarea');
                
                const filePromises = [];
                
                inputs.forEach(i=>{
                    if(i.id) {
                        if (i.type === 'file' && i.files.length > 0) {
                           for (const file of i.files) {
                                filePromises.push(new Promise((resolve, reject) => {
                                    const reader = new FileReader();
                                    reader.onload = e => resolve({ id: i.id, file: { name: file.name, type: file.type, data: e.target.result } });
                                    reader.onerror = err => reject(err);
                                    reader.readAsArrayBuffer(file);
                                }));
                            }
                        } else if (i.type !== 'file') {
                            data[i.id] = i.value;
                        }
                    }
                });
                
                const fileData = await Promise.all(filePromises);
                fileData.forEach(fileInfo => {
                    if (!data[fileInfo.id]) data[fileInfo.id] = [];
                     // For simplicity, just storing file names. For storing content, blobs would be better.
                    data[fileInfo.id].push(fileInfo.file.name);
                });
                
                await dbOp.save(data); 

                dom.saveProgressBar.style.width='100%';
                ui.showToast('toast_saved');
                setTimeout(() => { showPage('page-detail', {id:data.id}); dom.saveProgressBar.style.width='0%'; dom.formSaveBtn.disabled = false; }, 500);
            };

            const startScanner = () => {
                // ... scanner logic ...
            };

            const handleExport = async (format, data) => {
                const buildings = data || await dbOp.getAll();
                if (buildings.length === 0) { ui.showToast("toast_no_data_export", true); return; }
                
                if (format === 'xlsx') { 
                    const ws = XLSX.utils.json_to_sheet(buildings); 
                    const wb = XLSX.utils.book_new(); 
                    XLSX.utils.book_append_sheet(wb, ws, "Buildings"); 
                    XLSX.writeFile(wb, "Building_Export.xlsx"); 
                }
                ui.showToast('toast_exported', false, {format: format.toUpperCase()});
            };

            const downloadQrAsImage = async (building) => {
                const qrSize = 250;
                const border = 10;
                const textHeight = 80;
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = qrSize + border * 2;
                canvas.height = qrSize + border * 2 + textHeight;

                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = '#000000';
                ctx.font = 'bold 20px Ubuntu';
                ctx.textAlign = 'center';
                ctx.fillText(building.buildingName || '', canvas.width / 2, 35);

                const qrInstance = new QRCodeStyling({ 
                    width: qrSize, 
                    height: qrSize, 
                    data: String(building.id),
                    dotsOptions: { color: '#000000', type: 'square' },
                    backgroundOptions: { color: '#ffffff' }
                });
                const qrBlob = await qrInstance.getRawData('png');
                const qrImage = await createImageBitmap(qrBlob);
                ctx.drawImage(qrImage, border, 50);

                ctx.fillStyle = '#333333';
                ctx.font = '16px Ubuntu';
                ctx.textAlign = 'center';
                ctx.fillText(building.buildingAddressPostal || '', canvas.width / 2, canvas.height - 15);

                const link = document.createElement('a');
                link.download = `QR-${building.buildingName.replace(/\s/g, '_')}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
            };

            const pdf = {
                generate: async (b) => {
                    const { jsPDF } = window.jspdf; 
                    const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                    const FONT = "Helvetica"; 
                    doc.setFont(FONT);

                    const margin = 15;
                    const pageW = doc.internal.pageSize.getWidth();
                    let y = 20;

                    // QR Code
                    const qrInstance = new QRCodeStyling({ width: 200, height: 200, data: String(b.id), dotsOptions: { color: '#000000' } });
                    const qrBlob = await qrInstance.getRawData('png');
                    const qrImage = await blobToDataURI(qrBlob);
                    doc.addImage(qrImage, 'PNG', pageW - margin - 30, 15, 30, 30);

                    // Title
                    doc.setFontSize(22);
                    doc.setFont(FONT, 'bold');
                    doc.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--primary-color'));
                    doc.text(b.buildingName || "Building Details", margin, y);
                    y += 15;

                    const addField = (label, value) => {
                        if (!value) return;
                        if (y > 275) { doc.addPage(); y = 20; }
                        doc.setFontSize(10);
                        doc.setFont(FONT, 'bold');
                        doc.text(label + ":", margin, y);
                        doc.setFont(FONT, 'normal');
                        const splitValue = doc.splitTextToSize(String(value), pageW - margin * 2 - 35);
                        doc.text(splitValue, margin + 35, y);
                        y += (splitValue.length * 5) + 2;
                    };
                    
                    const addSectionHeader = (title) => {
                         if (y > 265) { doc.addPage(); y = 20; }
                         y+=5;
                         doc.setFontSize(14);
                         doc.setFont(FONT, 'bold');
                         doc.setTextColor('#333333');
                         doc.text(title, margin, y);
                         y += 8;
                         doc.setDrawColor('#cccccc');
                         doc.line(margin, y - 2, pageW - margin, y - 2);
                    }

                    addSectionHeader('Core Information');
                    addField('Project Name', b.projectName);
                    addField('Project Number', b.projectNumber);
                    addField('Building Status', b.buildingStatus);
                    addField('Address', `${b.buildingAddressStreet || ''}, ${b.buildingAddressCity || ''}`);
                    addField('Postal Code', b.buildingAddressPostal);
                    addField('Country', b.buildingAddressCountry);
                    addField('GPS', b.gpsLatitude && b.gpsLongitude ? `${b.gpsLatitude}, ${b.gpsLongitude}` : '');
                    addField('Primary Use', b.primaryUse);
                    addField('Gross Floor Area (m²)', b.grossFloorArea);
                    addField('Floors Above Ground', b.floorsAboveGround);
                    addField('Floors Below Ground', b.floorsBelowGround);
                    addField('Construction Year', b.constructionCompletionYear ? new Date(b.constructionCompletionYear).getFullYear() : '');
                    addField('Renovation Year', b.majorRenovationYear ? new Date(b.majorRenovationYear).getFullYear() : '');
                    
                    addSectionHeader('Design & As-Built');
                    addField('Arch. Model', b.architecturalModelLink);
                    addField('Struct. System', b.structuralSystemType);
                    addField('Floor Loading', b.floorLoadingCapacity);
                    addField('MEP Model', b.mepModelLink);
                    addField('Utility Shut-offs', b.utilityShutoffLocations);

                    addSectionHeader('Construction & Handover');
                    addField('Contractor', b.generalContractor);
                    addField('Architect', b.architectOfRecord);
                    addField('Struct. Engineer', b.structuralEngineer);
                    addField('MEP Engineer', b.mepEngineer);
                    addField('Construction Start', b.constructionStartDate);
                    addField('Handover Date', b.officialHandoverDate);
                    
                    addSectionHeader('Attached Documents');
                    const documentFields = {
                        'Site Plan': b.sitePlanDrawing, 'Occupancy Permit': b.occupancyPermit, 'Main Photo': b.mainBuildingPhoto,
                        'Arch. Drawings': b.asBuiltArchitecturalDrawings, 'Room Schedule': b.roomSchedule, 'Finishes Schedule': b.finishesSchedule,
                        'Struct. Drawings': b.asBuiltStructuralDrawings, 'Struct. Specs': b.structuralMaterialSpecs,
                        'MEP Drawings': b.asBuiltMepDrawings, 'MEP Equipment': b.mepEquipmentSchedule, 'Elec. Panels': b.electricalPanelSchedules,
                        'Commissioning': b.commissioningReport, 'Change Orders': b.changeOrdersLog, 'RFIs': b.rfiLog, 'Warranty Log': b.warrantyLog
                    };
                    Object.entries(documentFields).forEach(([label, value]) => addField(label, value));
                    
                    doc.save(`Building-${b.buildingName.replace(/\s/g,'_')}.pdf`);
                }
            };

            const handleExcelImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const buildings = XLSX.utils.sheet_to_json(firstSheet);

                        if (buildings.length > 0) {
                            for (const buildingData of buildings) {
                                if(!buildingData.id) buildingData.id = crypto.randomUUID();
                                await dbOp.save(buildingData);
                            }
                            ui.showToast('toast_imported', false, {count: buildings.length});
                            await ui.renderAdminList();
                        }
                    } catch (err) {
                        console.error("Import error:", err);
                        ui.showToast('toast_import_error', true);
                    } finally {
                        event.target.value = '';
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            // --- Event Listeners ---
            dom.backButton.addEventListener('click', () => goBack());
            document.querySelectorAll('.nav-button[data-target]').forEach(btn => btn.addEventListener('click', (e) => showPage(e.currentTarget.dataset.target)));
            
            document.getElementById('lang-switcher').addEventListener('click', () => { state.currentLang = state.currentLang === 'en' ? 'fa' : 'en'; localStorage.setItem(LANG_KEY, state.currentLang); ui.updateText(); const currentId = dom.form.id.value; showPage(state.currentPage, {id:currentId}, true); });
            dom.searchBar.addEventListener('input', (e) => { if (state.currentPage === 'page-admin') ui.renderAdminList(e.target.value); });
            dom.formSaveBtn.addEventListener('click', handleFormSave);
            dom.formCancelBtn.addEventListener('click', () => goBack());
            document.getElementById('get-location-btn').addEventListener('click', () => { if ('geolocation' in navigator) navigator.geolocation.getCurrentPosition(p => { document.getElementById('gpsLatitude').value = p.coords.latitude.toFixed(6); document.getElementById('gpsLongitude').value = p.coords.longitude.toFixed(6); ui.showToast('toast_location_captured'); }, () => ui.showToast('toast_location_fail', true)); else ui.showToast('toast_geo_unsupported', true); });
            document.getElementById('confirm-modal-no').addEventListener('click', ui.hideConfirmModal);
            document.getElementById('confirm-modal-yes').addEventListener('click', () => { if (typeof state.confirmCallback === 'function') state.confirmCallback(); ui.hideConfirmModal(); });
            dom.confirmModalOverlay.addEventListener('click', (e) => { if (e.target === dom.confirmModalOverlay) ui.hideConfirmModal(); });
            dom.importExcelBtn.addEventListener('click', () => dom.importExcelInput.click());
            dom.importExcelInput.addEventListener('change', handleExcelImport);
            
            // INITIALIZATION
            async function init() {
                try {
                    await openDB();
                    ui.updateText();
                    showPage('page-home');
                } catch (error) {
                    ui.showToast('toast_db_error', true);
                    console.error("Failed to initialize the application:", error);
                }
            }

            init();
        });
    </script>
</body>
</html>
