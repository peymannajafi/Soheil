<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Building Info</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">


    <!-- QR Code Generation and Scanning libraries -->
    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- Libraries for CSV and Excel handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>


    <style>
        /* Basic styles and theme setup */
        body {
            font-family: 'Ubuntu', sans-serif;
        }
        html[dir="rtl"] body {
            font-family: 'Vazirmatn', sans-serif;
        }
        .page {
            display: none; /* Hide all pages by default */
        }
        .page.active {
            display: block; /* Show active page */
        }
        /* Custom styles for QR Scanner */
        #qr-reader-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            border-radius: 1rem;
            overflow: hidden;
            border: 4px solid #1e3a8a; /* Navy Blue */
        }
        /* Thumbnail styles */
        .thumbnail-container {
            position: relative;
        }
        .thumbnail-delete {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: red;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            border: 2px solid white;
        }
        html[dir="rtl"] .thumbnail-delete {
            right: auto;
            left: -10px;
        }
        #form-qr-code-container {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: white;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        html[dir="rtl"] #form-qr-code-container {
             right: auto;
             left: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Main Application Container -->
    <div id="app" class="max-w-4xl mx-auto">

        <!-- Header -->
        <header class="bg-blue-800 text-white shadow-md sticky top-0 z-50">
            <div class="mx-auto px-4 py-4 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <svg id="back-button" class="w-6 h-6 cursor-pointer hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    <h1 id="header-title" class="text-xl font-bold"></h1>
                </div>
                 <div class="flex items-center space-x-4">
                    <div id="header-actions"></div>
                    <button id="lang-switcher" class="font-bold text-lg p-2 rounded-md hover:bg-blue-700 w-12 text-center"></button>
                </div>
            </div>
        </header>

        <main class="p-4 md:p-6">
            <!-- ========== PAGES ========== -->

            <!-- 1. Home Page -->
            <div id="page-home" class="page active">
                <div class="flex flex-col space-y-4 max-w-sm mx-auto mt-16 text-center">
                    <button data-target="page-scanner" class="nav-button bg-blue-700 hover:bg-blue-800 text-white font-bold py-4 px-6 rounded-lg shadow-lg flex items-center justify-center space-x-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        <span data-lang="scan_qr"></span>
                    </button>
                    <button data-target="page-admin" class="nav-button bg-gray-700 hover:bg-gray-800 text-white font-bold py-4 px-6 rounded-lg shadow-lg flex items-center justify-center space-x-3">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        <span data-lang="add_building"></span>
                    </button>
                    <div class="pt-8">
                        <label for="import-file" class="text-blue-600 hover:text-blue-800 font-semibold cursor-pointer" data-lang="import_data_file"></label>
                        <input type="file" id="import-file" class="hidden" accept=".json,.csv,.xls,.xlsx">
                    </div>
                </div>
            </div>

            <!-- 2. Admin Page -->
            <div id="page-admin" class="page">
                <div class="mb-4 sticky top-[64px] bg-gray-100 py-2 z-10">
                    <input type="search" id="search-bar" class="w-full p-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" autocomplete="off">
                </div>
                <div id="building-list" class="space-y-3">
                    <!-- Building list items will be inserted here -->
                </div>
                <div id="empty-admin-state" class="text-center mt-16 text-gray-500 hidden">
                    <p data-lang="no_buildings_found"></p>
                    <p data-lang="click_plus_to_add"></p>
                </div>
            </div>

            <!-- 3. Building Form Page -->
            <div id="page-form" class="page relative">
                <div id="form-qr-code-container" class="hidden md:block"></div>
                <form id="building-form" class="space-y-6">
                    <input type="hidden" id="id">
                    
                    <!-- Basic Info & Address Section -->
                    <div class="bg-white p-4 rounded-lg shadow">
                         <h3 class="font-bold text-lg mb-4 border-b pb-2 text-blue-800" data-lang="form_section_address"></h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label for="buildingName" class="block text-sm font-medium text-gray-700" data-lang="form_building_name"></label>
                                <input type="text" id="buildingName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="address" class="block text-sm font-medium text-gray-700" data-lang="form_street"></label>
                                <input type="text" id="address" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="city" class="block text-sm font-medium text-gray-700" data-lang="form_city"></label>
                                <input type="text" id="city" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                              <div>
                                <label for="stateProvince" class="block text-sm font-medium text-gray-700" data-lang="form_state_province"></label>
                                <input type="text" id="stateProvince" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="zipPostal" class="block text-sm font-medium text-gray-700" data-lang="form_zip_postal"></label>
                                <input type="text" id="zipPostal" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="country" class="block text-sm font-medium text-gray-700" data-lang="form_country"></label>
                                <input type="text" id="country" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="webpage" class="block text-sm font-medium text-gray-700" data-lang="form_webpage"></label>
                                <input type="url" id="webpage" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                         </div>
                    </div>

                    <!-- Property Profile Section -->
                    <div class="bg-white p-4 rounded-lg shadow">
                         <h3 class="font-bold text-lg mb-4 border-b pb-2 text-blue-800" data-lang="form_section_profile"></h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="buildingUseType" class="block text-sm font-medium text-gray-700" data-lang="form_property_type"></label>
                                <select id="buildingUseType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </select>
                            </div>
                             <div>
                                <label for="yearBuilt" class="block text-sm font-medium text-gray-700" data-lang="form_year_built"></label>
                                <input type="number" id="yearBuilt" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                             <div>
                                <label for="squareFeet" class="block text-sm font-medium text-gray-700" data-lang="form_sqm"></label>
                                <input type="number" id="squareFeet" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="bedrooms" class="block text-sm font-medium text-gray-700" data-lang="form_bedrooms"></label>
                                <div class="flex items-center mt-1">
                                    <button type="button" class="stepper-btn bg-gray-200 text-lg font-bold rounded-l px-3 py-1.5" data-target="bedrooms" data-action="decrement">-</button>
                                    <input type="text" id="bedrooms" value="0" readonly class="w-full text-center border-t border-b border-gray-300 shadow-sm focus:outline-none py-1.5">
                                    <button type="button" class="stepper-btn bg-gray-200 text-lg font-bold rounded-r px-3 py-1.5" data-target="bedrooms" data-action="increment">+</button>
                                </div>
                            </div>
                             <div>
                                <label for="bathrooms" class="block text-sm font-medium text-gray-700" data-lang="form_bathrooms"></label>
                                 <div class="flex items-center mt-1">
                                    <button type="button" class="stepper-btn bg-gray-200 text-lg font-bold rounded-l px-3 py-1.5" data-target="bathrooms" data-action="decrement">-</button>
                                    <input type="text" id="bathrooms" value="0" readonly class="w-full text-center border-t border-b border-gray-300 shadow-sm focus:outline-none py-1.5">
                                    <button type="button" class="stepper-btn bg-gray-200 text-lg font-bold rounded-r px-3 py-1.5" data-target="bathrooms" data-action="increment">+</button>
                                </div>
                            </div>
                            <div class="flex items-center mt-2 md:mt-8">
                                <input type="checkbox" id="garage" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="garage" class="ml-2 block text-sm text-gray-900" data-lang="form_garage"></label>
                            </div>
                            <div class="md:col-span-2">
                                <label for="euClassification" class="block text-sm font-medium text-gray-700" data-lang="form_eu_classification"></label>
                                <select id="euClassification" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Section -->
                     <div class="bg-white p-4 rounded-lg shadow">
                         <h3 class="font-bold text-lg mb-4 border-b pb-2 text-blue-800" data-lang="form_section_financials"></h3>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             <div>
                                <label for="loanAmount" class="block text-sm font-medium text-gray-700" data-lang="form_loan_amount"></label>
                                <input type="number" id="loanAmount" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <span id="loanAmount-formatted" class="text-sm text-gray-500 block mt-1"></span>
                            </div>
                              <div>
                                <label for="assessedValue" class="block text-sm font-medium text-gray-700" data-lang="form_assessed_value"></label>
                                <input type="number" id="assessedValue" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <span id="assessedValue-formatted" class="text-sm text-gray-500 block mt-1"></span>
                            </div>
                            <div>
                                <label for="currentValue" class="block text-sm font-medium text-gray-700" data-lang="form_current_value"></label>
                                <input type="number" id="currentValue" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <span id="currentValue-formatted" class="text-sm text-gray-500 block mt-1"></span>
                            </div>
                              <div>
                                <label for="downPayment" class="block text-sm font-medium text-gray-700" data-lang="form_down_payment"></label>
                                <input type="number" id="downPayment" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <span id="downPayment-formatted" class="text-sm text-gray-500 block mt-1"></span>
                            </div>
                            <div>
                                <label for="monthlyMortgage" class="block text-sm font-medium text-gray-700" data-lang="form_monthly_mortgage"></label>
                                <input type="number" id="monthlyMortgage" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <span id="monthlyMortgage-formatted" class="text-sm text-gray-500 block mt-1"></span>
                            </div>
                             <div>
                                <label for="housingDues" class="block text-sm font-medium text-gray-700" data-lang="form_housing_dues"></label>
                                <input type="number" id="housingDues" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <span id="housingDues-formatted" class="text-sm text-gray-500 block mt-1"></span>
                            </div>
                             <div>
                                <label for="tax" class="block text-sm font-medium text-gray-700" data-lang="form_tax"></label>
                                <input type="number" id="tax" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <span id="tax-formatted" class="text-sm text-gray-500 block mt-1"></span>
                            </div>
                             <div>
                                <label for="insurance" class="block text-sm font-medium text-gray-700" data-lang="form_insurance"></label>
                                <input type="number" id="insurance" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <span id="insurance-formatted" class="text-sm text-gray-500 block mt-1"></span>
                            </div>
                         </div>
                    </div>
                    
                    <!-- Location Section -->
                     <div class="bg-white p-4 rounded-lg shadow">
                         <h3 class="font-bold text-lg mb-4 border-b pb-2 text-blue-800" data-lang="form_section_location"></h3>
                         <div class="flex items-center space-x-4 mb-2">
                            <div class="flex-1">
                                <label for="latitude" class="block text-sm font-medium text-gray-700" data-lang="form_latitude"></label>
                                <input type="text" id="latitude" readonly class="mt-1 bg-gray-100 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                             <div class="flex-1">
                                <label for="longitude" class="block text-sm font-medium text-gray-700" data-lang="form_longitude"></label>
                                <input type="text" id="longitude" readonly class="mt-1 bg-gray-100 block w-full rounded-md border-gray-300 shadow-sm">
                            </div>
                         </div>
                          <button type="button" id="get-location-btn" class="w-full mt-2 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg" data-lang="form_get_location"></button>
                    </div>

                    <!-- Photos Section -->
                    <div class="bg-white p-4 rounded-lg shadow">
                         <h3 class="font-bold text-lg mb-4 border-b pb-2 text-blue-800" data-lang="form_section_photos"></h3>
                         <p class="text-sm text-gray-500 mb-4" data-lang="form_photos_note"></p>
                         <div class="flex space-x-4">
                             <label for="photo-upload" class="flex-1 text-center bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg cursor-pointer" data-lang="form_upload_gallery"></label>
                             <input type="file" id="photo-upload" class="hidden" accept="image/*" multiple>
                             
                             <label for="photo-capture" class="flex-1 text-center bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg cursor-pointer" data-lang="form_take_photo"></label>
                             <input type="file" id="photo-capture" class="hidden" accept="image/*" capture="user">
                         </div>
                         <div id="photo-thumbnails" class="mt-4 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4">
                            <!-- Image thumbnails will be added here -->
                         </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="bg-white p-4 rounded-lg shadow">
                         <h3 class="font-bold text-lg mb-4 border-b pb-2 text-blue-800" data-lang="form_section_notes"></h3>
                        <textarea id="notes" rows="4" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"></textarea>
                    </div>

                </form>
            </div>

            <!-- 4. Building Detail Page -->
            <div id="page-detail" class="page">
                <div id="detail-content" class="space-y-4">
                    <!-- Detail rows and QR code will be inserted here -->
                </div>
            </div>

            <!-- 5. QR Scanner Page -->
            <div id="page-scanner" class="page">
                <div id="qr-reader-container">
                    <div id="qr-reader"></div>
                </div>
                <p class="text-center text-gray-500 mt-4" data-lang="scan_instruction"></p>
            </div>
            
            <!-- 6. Settings Page -->
            <div id="page-settings" class="page">
                <div class="space-y-4">
                    <div>
                        <h3 class="font-bold text-lg mb-2" data-lang="settings_import_title"></h3>
                         <label for="import-file-settings" class="w-full text-left bg-white p-4 rounded-lg shadow hover:bg-gray-50 flex justify-between items-center cursor-pointer">
                            <div>
                                <p class="font-semibold" data-lang="settings_import_button"></p>
                                <p class="text-gray-600 text-sm" data-lang="settings_import_desc"></p>
                            </div>
                            <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        </label>
                        <input type="file" id="import-file-settings" class="hidden" accept=".json,.csv,.xls,.xlsx">
                    </div>
                    <div>
                        <h3 class="font-bold text-lg mb-2" data-lang="settings_export_title"></h3>
                        <div class="space-y-3">
                             <button id="export-json" class="w-full text-left bg-white p-4 rounded-lg shadow hover:bg-gray-50 flex justify-between items-center">
                                <div>
                                    <p class="font-semibold" data-lang="settings_export_json"></p>
                                    <p class="text-gray-600 text-sm" data-lang="settings_export_json_desc"></p>
                                </div>
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            </button>
                             <button id="export-csv" class="w-full text-left bg-white p-4 rounded-lg shadow hover:bg-gray-50 flex justify-between items-center">
                                <div>
                                    <p class="font-semibold" data-lang="settings_export_csv"></p>
                                    <p class="text-gray-600 text-sm" data-lang="settings_export_csv_desc"></p>
                                </div>
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            </button>
                             <button id="export-xlsx" class="w-full text-left bg-white p-4 rounded-lg shadow hover:bg-gray-50 flex justify-between items-center">
                                <div>
                                    <p class="font-semibold" data-lang="settings_export_xlsx"></p>
                                    <p class="text-gray-600 text-sm" data-lang="settings_export_xlsx_desc"></p>
                                </div>
                                <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Global Toast/Notification -->
        <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 opacity-0">
            <p id="toast-message"></p>
        </div>

    </div>

    <script>
        // --- APPLICATION LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- STATE & CONFIG ---
            const DB_KEY = 'qrBuildingApp_buildings';
            const LANG_KEY = 'qrBuildingApp_lang';
            const state = {
                currentPage: 'page-home',
                history: [], // For back button functionality
                activeScanner: null,
                photoCache: [], // Temporary cache for photos on the form page
                currentLang: localStorage.getItem(LANG_KEY) || 'en',
            };

            // --- TRANSLATIONS ---
            const translations = {
                en: {
                    app_title: "Building Information Hub", admin_title: "Admin: Records", add_building_title: "Add Building", edit_building_title: "Edit Building", detail_title_prefix: "", scan_title: "Scan QR Code", settings_title: "Settings & Data", scan_qr: "Scan Building QR Code", add_building: "Add Building", import_data_file: "Import Building Data File (JSON, CSV, Excel)",
                    no_buildings_found: "No buildings found.", click_plus_to_add: "Click the '+' button to add one.",
                    search_placeholder: "Search by Zip Code...", no_search_results: "No buildings match your search.", try_different_search: "Try a different zip code.",
                    form_section_address: "Address & Basic Info", form_building_name: "Building Name / Profile Name *", form_street: "Street", form_city: "City", form_state_province: "State/Province", form_zip_postal: "Zip/Postal Code", form_country: "Country/Region", form_webpage: "Web Page",
                    form_section_profile: "Property Profile", form_property_type: "Property Type", form_year_built: "Year Built", form_sqm: "Square Meters (m²)", form_bedrooms: "Bedrooms", form_bathrooms: "Bathrooms", form_garage: "Garage", form_eu_classification: "EU Building Classification (CC)",
                    form_property_type_residential: 'Residential', form_property_type_commercial: 'Commercial', form_property_type_industrial: 'Industrial', form_property_type_institutional: 'Institutional', form_property_type_mixed: 'Mixed-Use', form_property_type_other: 'Other',
                    form_eu_select: 'Select a classification...', form_eu_111: 'Residential - One-dwelling', form_eu_112: 'Residential - Multi-dwelling', form_eu_122: 'Commercial - Office Building', form_eu_123: 'Commercial - Wholesale and retail trade', form_eu_125: 'Commercial - Industrial and warehouse', form_eu_126: 'Public - Entertainment, education, hospital', form_eu_127: 'Other non-residential',
                    form_section_financials: "Financials", form_loan_amount: "Loan Amount", form_assessed_value: "Assessed Value", form_current_value: "Current Value", form_down_payment: "Down Payment", form_monthly_mortgage: "Monthly Mortgage", form_housing_dues: "Housing Dues", form_tax: "Tax", form_insurance: "Insurance",
                    form_section_location: "GPS Location", form_latitude: "Latitude", form_longitude: "Longitude", form_get_location: "Get Current Location",
                    form_section_photos: "Photos", form_photos_note: "Note: Storing many large photos may slow down the app. Storage is limited by your browser.", form_upload_gallery: "Upload from Gallery", form_take_photo: "Take Photo",
                    form_section_notes: "Notes",
                    scan_instruction: "Point your camera at a QR code. Accessing your camera is required.",
                    settings_import_title: "Import Data", settings_import_button: "Import from File", settings_import_desc: "Overwrite data from a JSON, CSV, or Excel file.",
                    settings_export_title: "Export Data", settings_export_json: "Export as JSON", settings_export_json_desc: "Best for backups and re-importing.", settings_export_csv: "Export as CSV", settings_export_csv_desc: "Good for spreadsheets.", settings_export_xlsx: "Export as Excel (XLSX)", settings_export_xlsx_desc: "Best for Excel users.",
                    confirm_delete: "Are you sure you want to delete this building?", confirm_import: "This will import {count} records and overwrite all existing data. Are you sure?",
                    toast_saved: "Building saved successfully!", toast_deleted: "Building deleted.", toast_no_data_export: "No data to export.", toast_exported: "Data exported as {format} successfully!", toast_imported: "{count} buildings imported successfully!", toast_import_fail: "Failed to import file. Make sure it's a valid and correctly formatted file.",
                    toast_location_captured: "Location captured!", toast_location_fail: "Could not get location. Please enable GPS.", toast_geo_unsupported: "Geolocation is not supported by your browser.",
                    toast_camera_fail: "Could not start camera. Please grant permission.", toast_qr_not_found: "Building not found in local data.", toast_fill_fields: "Please fill in all required fields.",
                    yes: "Yes", no: "No", detail_full_address: "Full Address", detail_other_info: "Other Information", detail_open_maps: "Open in Google Maps", detail_qr_code: "Building QR Code", detail_download_qr: "Download QR Code"
                },
                fa: {
                    app_title: "مرکز اطلاعات ساختمان", admin_title: "مدیریت: رکوردها", add_building_title: "افزودن ساختمان", edit_building_title: "ویرایش ساختمان", detail_title_prefix: "", scan_title: "اسکن کد QR", settings_title: "تنظیمات و داده‌ها",
                    scan_qr: "اسکن کد QR ساختمان", add_building: "افزودن ساختمان", import_data_file: "ورود اطلاعات از فایل (JSON, CSV, Excel)",
                    no_buildings_found: "هیچ ساختمانی یافت نشد.", click_plus_to_add: "برای افزودن، روی دکمه '+' کلیک کنید.",
                    search_placeholder: "جستجو بر اساس کد پستی...", no_search_results: "هیچ ساختمانی با جستجوی شما مطابقت ندارد.", try_different_search: "یک کد پستی دیگر را امتحان کنید.",
                    form_section_address: "آدرس و اطلاعات اولیه", form_building_name: "نام ساختمان / نام پروفایل *", form_street: "خیابان", form_city: "شهر", form_state_province: "استان/ایالت", form_zip_postal: "کد پستی", form_country: "کشور", form_webpage: "صفحه وب",
                    form_section_profile: "مشخصات ملک", form_property_type: "نوع ملک", form_year_built: "سال ساخت", form_sqm: "متر مربع (m²)", form_bedrooms: "اتاق خواب", form_bathrooms: "حمام", form_garage: "پارکینگ", form_eu_classification: "طبقه‌بندی ساختمان (EU)",
                    form_property_type_residential: 'مسکونی', form_property_type_commercial: 'تجاری', form_property_type_industrial: 'صنعتی', form_property_type_institutional: 'اداری', form_property_type_mixed: 'مختلط', form_property_type_other: 'دیگر',
                    form_eu_select: 'یک طبقه‌بندی انتخاب کنید...', form_eu_111: 'مسکونی - یک واحدی', form_eu_112: 'مسکونی - چند واحدی', form_eu_122: 'تجاری - اداری', form_eu_123: 'تجاری - عمده و خرده فروشی', form_eu_125: 'صنعتی و انبار', form_eu_126: 'عمومی - تفریحی، آموزشی، بیمارستانی', form_eu_127: 'سایر غیرمسکونی‌ها',
                    form_section_financials: "اطلاعات مالی", form_loan_amount: "مبلغ وام", form_assessed_value: "ارزش ارزیابی شده", form_current_value: "ارزش فعلی", form_down_payment: "پیش پرداخت", form_monthly_mortgage: "قسط ماهانه", form_housing_dues: "شارژ ساختمان", form_tax: "مالیات", form_insurance: "بیمه",
                    form_section_location: "موقعیت GPS", form_latitude: "عرض جغرافیایی", form_longitude: "طول جغرافیایی", form_get_location: "دریافت موقعیت مکانی فعلی",
                    form_section_photos: "عکس‌ها", form_photos_note: "توجه: ذخیره عکس‌های زیاد و بزرگ ممکن است سرعت برنامه را کاهش دهد. فضای ذخیره‌سازی توسط مرورگر شما محدود است.", form_upload_gallery: "آپلود از گالری", form_take_photo: "گرفتن عکس",
                    form_section_notes: "یادداشت‌ها",
                    scan_instruction: "دوربین خود را به سمت کد QR بگیرید. دسترسی به دوربین الزامی است.",
                    settings_import_title: "ورود داده", settings_import_button: "ورود از فایل", settings_import_desc: "بازنویسی داده‌ها از فایل JSON، CSV یا Excel.",
                    settings_export_title: "خروج داده", settings_export_json: "خروجی به صورت JSON", settings_export_json_desc: "بهترین گزینه برای پشتیبان‌گیری و ورود مجدد.", settings_export_csv: "خروجی به صورت CSV", settings_export_csv_desc: "مناسب برای صفحات گسترده.", settings_export_xlsx: "خروجی به صورت Excel (XLSX)", settings_export_xlsx_desc: "بهترین گزینه برای کاربران اکسل.",
                    confirm_delete: "آیا از حذف این ساختمان مطمئن هستید؟", confirm_import: "این عملیات {count} رکورد را وارد کرده و تمام داده‌های موجود را بازنویسی می‌کند. آیا مطمئن هستید؟",
                    toast_saved: "ساختمان با موفقیت ذخیره شد!", toast_deleted: "ساختمان حذف شد.", toast_no_data_export: "داده‌ای برای خروج وجود ندارد.", toast_exported: "داده‌ها با موفقیت به صورت {format} خروجی گرفته شد!", toast_imported: "{count} ساختمان با موفقیت وارد شد!", toast_import_fail: "ورود فایل ناموفق بود. از معتبر و صحیح بودن فرمت فایل اطمینان حاصل کنید.",
                    toast_location_captured: "موقعیت مکانی ثبت شد!", toast_location_fail: "دریافت موقعیت مکانی ناموفق بود. لطفاً GPS را فعال کنید.", toast_geo_unsupported: "مرورگر شما از موقعیت‌یابی جغرافیایی پشتیبانی نمی‌کند.",
                    toast_camera_fail: "دوربین فعال نشد. لطفاً دسترسی را مجاز کنید.", toast_qr_not_found: "ساختمان در داده‌های محلی یافت نشد.", toast_fill_fields: "لطفاً تمام فیلدهای الزامی را پر کنید.",
                    yes: "بله", no: "خیر", detail_full_address: "آدرس کامل", detail_other_info: "سایر اطلاعات", detail_open_maps: "باز کردن در نقشه گوگل", detail_qr_code: "کد QR ساختمان", detail_download_qr: "دانلود کد QR"
                }
            };

            const translate = (key, params = {}) => {
                let text = translations[state.currentLang][key] || key;
                for(const param in params) {
                    text = text.replace(`{${param}}`, params[param]);
                }
                return text;
            }

            const formatCurrency = (number) => {
                if (isNaN(number) || number === '' || number === null) return '';
                const numericValue = Number(number);
                if (state.currentLang === 'fa') {
                    return new Intl.NumberFormat('fa-IR', { style: 'currency', currency: 'IRR', minimumFractionDigits: 0 }).format(numericValue);
                } else {
                    return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(numericValue); // Using de-DE for Euro formatting
                }
            };

            // --- DOM ELEMENTS ---
            const pages = document.querySelectorAll('.page');
            const headerTitle = document.getElementById('header-title');
            const backButton = document.getElementById('back-button');
            const headerActions = document.getElementById('header-actions');
            const buildingList = document.getElementById('building-list');
            const emptyAdminState = document.getElementById('empty-admin-state');
            const searchBar = document.getElementById('search-bar');
            const form = document.getElementById('building-form');
            const qrReader = document.getElementById('qr-reader');
            const importFileInput = document.getElementById('import-file');
            const importFileInputSettings = document.getElementById('import-file-settings');
            const exportJsonButton = document.getElementById('export-json');
            const exportCsvButton = document.getElementById('export-csv');
            const exportXlsxButton = document.getElementById('export-xlsx');
            const getLocationBtn = document.getElementById('get-location-btn');
            const photoUploadInput = document.getElementById('photo-upload');
            const photoCaptureInput = document.getElementById('photo-capture');
            
            // --- DATA SANITIZATION ---
            const sanitizeBuilding = (buildingData) => {
                return {
                    id: buildingData.id || db.uuid(),
                    buildingName: buildingData.buildingName || '',
                    address: buildingData.address || '',
                    city: buildingData.city || '',
                    stateProvince: buildingData.stateProvince || '',
                    zipPostal: buildingData.zipPostal || '',
                    country: buildingData.country || '',
                    webpage: buildingData.webpage || '',
                    yearBuilt: buildingData.yearBuilt || '',
                    buildingUseType: buildingData.buildingUseType || '',
                    euClassification: buildingData.euClassification || '',
                    loanAmount: buildingData.loanAmount || '',
                    assessedValue: buildingData.assessedValue || '',
                    currentValue: buildingData.currentValue || '',
                    squareFeet: buildingData.squareFeet || '',
                    bedrooms: buildingData.bedrooms || '',
                    bathrooms: buildingData.bathrooms || '',
                    garage: ['true', 'yes', '1'].includes(String(buildingData.garage).toLowerCase()),
                    monthlyMortgage: buildingData.monthlyMortgage || '',
                    housingDues: buildingData.housingDues || '',
                    tax: buildingData.tax || '',
                    insurance: buildingData.insurance || '',
                    downPayment: buildingData.downPayment || '',
                    latitude: buildingData.latitude || '',
                    longitude: buildingData.longitude || '',
                    ownerName: buildingData.ownerName || '',
                    notes: buildingData.notes || '',
                    photos: buildingData.photos && Array.isArray(buildingData.photos) ? buildingData.photos : [],
                };
            };
            
            // --- DATABASE LOGIC (using localStorage) ---
            const db = {
                // Generate a unique ID (simple version)
                uuid: () => {
                    const buildings = db.getAll();
                    if (buildings.length === 0) return 1;
                    return Math.max(...buildings.map(b => Number(b.id) || 0)) + 1;
                },
                
                // Get all buildings from localStorage
                getAll: () => JSON.parse(localStorage.getItem(DB_KEY) || '[]'),
                
                // Get a single building by its ID
                getById: (id) => db.getAll().find(b => String(b.id) === String(id)),
                
                // Save a building (add or update)
                save: (buildingData) => {
                    const buildings = db.getAll();
                    const buildingToSave = sanitizeBuilding(buildingData);
                    const index = buildings.findIndex(b => String(b.id) === String(buildingToSave.id));
                    if (index > -1) {
                        buildings[index] = buildingToSave; // Update
                    } else {
                        buildings.push(buildingToSave); // Add
                    }
                    localStorage.setItem(DB_KEY, JSON.stringify(buildings));
                },
                
                // Delete a building by ID
                delete: (id) => {
                    let buildings = db.getAll();
                    buildings = buildings.filter(b => String(b.id) !== String(id));
                    localStorage.setItem(DB_KEY, JSON.stringify(buildings));
                },
                
                // Clear all data
                clear: () => {
                    localStorage.removeItem(DB_KEY);
                }
            };
            
            // --- UI RENDERING & TRANSLATION ---
            const ui = {
                updateText: () => {
                    document.documentElement.lang = state.currentLang;
                    document.documentElement.dir = state.currentLang === 'fa' ? 'rtl' : 'ltr';
                    document.getElementById('lang-switcher').textContent = state.currentLang === 'en' ? 'FA' : 'EN';
                    
                    document.querySelectorAll('[data-lang]').forEach(el => {
                        const key = el.dataset.lang;
                        if (key) el.textContent = translate(key);
                    });
                    
                    const searchBarEl = document.getElementById('search-bar');
                    if (searchBarEl) {
                        searchBarEl.placeholder = translate('search_placeholder');
                    }
                    
                    const propertyTypeSelect = document.getElementById('buildingUseType');
                    propertyTypeSelect.innerHTML = `
                        <option>${translate('form_property_type_residential') || 'Residential'}</option>
                        <option>${translate('form_property_type_commercial') || 'Commercial'}</option>
                        <option>${translate('form_property_type_industrial') || 'Industrial'}</option>
                        <option>${translate('form_property_type_institutional') || 'Institutional'}</option>
                        <option>${translate('form_property_type_mixed') || 'Mixed-Use'}</option>
                        <option>${translate('form_property_type_other') || 'Other'}</option>
                    `;

                     const euSelect = document.getElementById('euClassification');
                     euSelect.innerHTML = `
                        <option value="">${translate('form_eu_select') || 'Select a classification...'}</option>
                        <option value="111">${translate('form_eu_111') || 'Residential - One-dwelling'}</option>
                        <option value="112">${translate('form_eu_112') || 'Residential - Multi-dwelling'}</option>
                        <option value="122">${translate('form_eu_122') || 'Commercial - Office Building'}</option>
                        <option value="123">${translate('form_eu_123') || 'Commercial - Wholesale and retail trade'}</option>
                        <option value="125">${translate('form_eu_125') || 'Commercial - Industrial and warehouse'}</option>
                        <option value="126">${translate('form_eu_126') || 'Public - Entertainment, education, hospital'}</option>
                        <option value="127">${translate('form_eu_127') || 'Other non-residential'}</option>
                     `;
                },

                renderAdminList: (searchTerm = '') => {
                    let buildings = db.getAll();
                    const normalizedSearchTerm = searchTerm.toLowerCase().trim();

                    if (normalizedSearchTerm) {
                        buildings = buildings.filter(building => 
                            building.zipPostal && building.zipPostal.toLowerCase().includes(normalizedSearchTerm)
                        );
                    }
                    
                    buildingList.innerHTML = '';
                    
                    if (buildings.length === 0) {
                        emptyAdminState.classList.remove('hidden');
                        const noBuildingsMsg = document.querySelector('#empty-admin-state p[data-lang="no_buildings_found"]');
                        const clickPlusMsg = document.querySelector('#empty-admin-state p[data-lang="click_plus_to_add"]');
                        
                        if (normalizedSearchTerm) {
                            noBuildingsMsg.textContent = translate('no_search_results');
                            clickPlusMsg.textContent = translate('try_different_search');
                        } else {
                            noBuildingsMsg.textContent = translate('no_buildings_found');
                            clickPlusMsg.textContent = translate('click_plus_to_add');
                        }
                    } else {
                        emptyAdminState.classList.add('hidden');
                        buildings.forEach(building => {
                            const item = document.createElement('div');
                            item.className = 'bg-white p-4 rounded-lg shadow hover:bg-gray-50 cursor-pointer';
                            item.dataset.id = building.id;
                            const zipBadge = building.zipPostal ? `<span class="bg-blue-100 text-blue-800 text-xs font-medium ${state.currentLang === 'fa' ? 'me-2' : 'ms-2'} px-2.5 py-0.5 rounded-full">${building.zipPostal}</span>` : '';
                            item.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-bold text-lg">${building.buildingName}</h3>
                                        <p class="text-gray-600">${building.address || 'No address'}</p>
                                    </div>
                                    ${zipBadge}
                                </div>
                            `;
                            item.addEventListener('click', () => showPage('page-detail', { buildingId: building.id }));
                            buildingList.appendChild(item);
                        });
                    }
                },
                
                renderDetail: (building, isAdminView) => {
                    const content = document.getElementById('detail-content');
                    content.innerHTML = '';

                    const createSection = (titleKey) => {
                        const section = document.createElement('div');
                        section.className = 'bg-white p-4 rounded-lg shadow-md';
                        const sectionContent = document.createElement('div');
                        sectionContent.className = 'space-y-3';
                        if (titleKey) {
                             const heading = document.createElement('h3');
                             heading.className = 'font-bold text-lg mb-3 border-b border-gray-200 pb-2 text-blue-800';
                             heading.textContent = translate(titleKey);
                             section.appendChild(heading);
                        } 
                        section.appendChild(sectionContent);
                        return section;
                    };
                    
                    const createFieldRow = (labelKey, value) => {
                         if (!value && value !== false && value !== 0) return null;
                         const row = document.createElement('div');
                         row.innerHTML = `<p class="text-sm font-medium text-gray-500">${translate(labelKey)}</p><p class="text-lg mt-1 break-words text-gray-800">${value}</p>`;
                         return row;
                    };

                    const addField = (section, labelKey, value, isCurrency = false) => {
                        let displayValue = value;
                        if (isCurrency) {
                            displayValue = formatCurrency(value);
                        }
                        const row = createFieldRow(labelKey, displayValue);
                        if(row) section.lastChild.appendChild(row);
                    }

                    const mainInfoSection = createSection(null);
                    addField(mainInfoSection, 'form_building_name', building.buildingName);
                    const fullAddress = [building.address, building.city, building.stateProvince, building.zipPostal, building.country].filter(Boolean).join(', ');
                    addField(mainInfoSection, 'detail_full_address', fullAddress);
                    if (building.webpage) {
                        const webpageRow = document.createElement('div');
                        webpageRow.innerHTML = `<p class="text-sm font-medium text-gray-500">${translate('form_webpage')}</p><a href="${building.webpage}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline break-all">${building.webpage}</a>`;
                        mainInfoSection.lastChild.appendChild(webpageRow);
                    }
                    content.appendChild(mainInfoSection);

                    const profileSection = createSection('form_section_profile');
                    addField(profileSection, 'form_property_type', building.buildingUseType);
                    addField(profileSection, 'form_eu_classification', building.euClassification);
                    addField(profileSection, 'form_year_built', building.yearBuilt);
                    addField(profileSection, 'form_sqm', building.squareFeet);
                    addField(profileSection, 'form_bedrooms', building.bedrooms);
                    addField(profileSection, 'form_bathrooms', building.bathrooms);
                    addField(profileSection, 'form_garage', building.garage ? translate('yes') : translate('no'));
                    if (profileSection.lastChild.children.length > 0) content.appendChild(profileSection);

                    const financialSection = createSection('form_section_financials');
                    addField(financialSection, 'form_loan_amount', building.loanAmount, true);
                    addField(financialSection, 'form_assessed_value', building.assessedValue, true);
                    addField(financialSection, 'form_current_value', building.currentValue, true);
                    addField(financialSection, 'form_down_payment', building.downPayment, true);
                    addField(financialSection, 'form_monthly_mortgage', building.monthlyMortgage, true);
                    addField(financialSection, 'form_housing_dues', building.housingDues, true);
                    addField(financialSection, 'form_tax', building.tax, true);
                    addField(financialSection, 'form_insurance', building.insurance, true);
                    if (financialSection.lastChild.children.length > 0) content.appendChild(financialSection);

                    const otherSection = createSection('detail_other_info');
                    addField(otherSection, 'ownerName', building.ownerName);
                    addField(otherSection, 'form_section_notes', building.notes);
                    if (otherSection.lastChild.children.length > 0) content.appendChild(otherSection);

                    if (building.latitude && building.longitude) {
                        const locationSection = createSection('form_section_location');
                        locationSection.lastChild.innerHTML = `<p class="text-lg mt-1">${building.latitude}, ${building.longitude}</p><a href="https://www.google.com/maps?q=${building.latitude},${building.longitude}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">${translate('detail_open_maps')}</a>`;
                        content.appendChild(locationSection);
                    }

                    if (building.photos && building.photos.length > 0) {
                         const photoSection = createSection('form_section_photos');
                         const photoGrid = document.createElement('div');
                         photoGrid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4';
                         building.photos.forEach(photoSrc => {
                            photoGrid.innerHTML += `<img src="${photoSrc}" class="rounded-lg w-full h-auto object-cover shadow-md">`;
                         });
                         photoSection.lastChild.appendChild(photoGrid);
                         content.appendChild(photoSection);
                    }

                    if (isAdminView) {
                        const qrCard = document.createElement('div');
                        qrCard.className = 'bg-white p-6 rounded-lg shadow text-center mt-4';
                        qrCard.innerHTML = `<h3 class="text-lg font-bold text-blue-800 mb-2">${translate('detail_qr_code')}</h3><div id="detail-qr-code-container" class="mt-4 flex justify-center"></div><div class="mt-6"><button id="detail-download-qr-button" class="bg-blue-700 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg">${translate('detail_download_qr')}</button></div>`;
                        content.appendChild(qrCard);
                        const qrCode = new QRCodeStyling({ width: 250, height: 250, data: building.id, dotsOptions: { color: '#1e3a8a', type: 'rounded' }, backgroundOptions: { color: '#ffffff' }, cornersSquareOptions: { color: '#1e40af', type: 'extra-rounded' }, cornersDotOptions: { color: '#1e40af', type: 'dot' } });
                        qrCode.append(document.getElementById('detail-qr-code-container'));
                        document.getElementById('detail-download-qr-button').onclick = () => qrCode.download({ name: `qr-${building.buildingName.replace(/\s+/g, '-')}`, extension: 'png' });
                    }
                },
                
                renderPhotoThumbnails: () => {
                    const container = document.getElementById('photo-thumbnails');
                    container.innerHTML = '';
                    state.photoCache.forEach((photoSrc, index) => {
                        const thumbContainer = document.createElement('div');
                        thumbContainer.className = 'thumbnail-container';
                        const img = document.createElement('img');
                        img.src = photoSrc;
                        img.className = 'w-full h-auto rounded-lg shadow';
                        const deleteBtn = document.createElement('div');
                        deleteBtn.className = 'thumbnail-delete';
                        deleteBtn.innerHTML = '&times;';
                        deleteBtn.onclick = () => {
                            state.photoCache.splice(index, 1);
                            ui.renderPhotoThumbnails();
                        };
                        thumbContainer.appendChild(img);
                        thumbContainer.appendChild(deleteBtn);
                        container.appendChild(thumbContainer);
                    });
                },
                
                renderFormQRCode: (id) => {
                    const container = document.getElementById('form-qr-code-container');
                    container.innerHTML = '';
                     const qrCode = new QRCodeStyling({ width: 100, height: 100, data: String(id), dotsOptions: { color: '#1e3a8a', type: 'rounded' }, backgroundOptions: { color: '#ffffff' } });
                     qrCode.append(container);
                },
                
                showToast: (message, isError = false, params = {}) => {
                    const toast = document.getElementById('toast');
                    const toastMessage = document.getElementById('toast-message');
                    toastMessage.textContent = translate(message, params);
                    toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg transition-opacity duration-300 opacity-100 ${isError ? 'bg-red-600' : 'bg-gray-900'}`;
                    setTimeout(() => toast.classList.replace('opacity-100', 'opacity-0'), 3000);
                }
            };

            // --- PAGE NAVIGATION & HEADER CONTROL ---
            const showPage = (pageId, params = {}, isGoingBack = false) => {
                if (state.activeScanner) { state.activeScanner.stop().catch(err => {}); state.activeScanner = null; }
                if (!isGoingBack && state.currentPage !== pageId) { state.history.push(state.currentPage); }
                state.currentPage = pageId;
                pages.forEach(p => p.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
                backButton.classList.toggle('hidden', pageId === 'page-home');
                headerActions.innerHTML = '';

                let titleKey = 'app_title';
                switch(pageId) {
                    case 'page-admin': titleKey = 'admin_title'; break;
                    case 'page-form': titleKey = params.buildingId ? 'edit_building_title' : 'add_building_title'; break;
                    case 'page-detail': 
                        const building = db.getById(params.buildingId);
                        if (building) {
                            headerTitle.textContent = translate('detail_title_prefix') + " " + building.buildingName;
                        } else {
                            titleKey = 'app_title';
                        }
                        break;
                    case 'page-scanner': titleKey = 'scan_title'; break;
                    case 'page-settings': titleKey = 'settings_title'; break;
                }
                if (pageId !== 'page-detail') {
                    headerTitle.textContent = translate(titleKey);
                }

                if (pageId === 'page-admin') {
                    headerActions.innerHTML = `<div class="flex items-center space-x-2"><button id="add-building-btn" class="p-2 rounded-full hover:bg-blue-700"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg></button><button id="settings-btn" class="p-2 rounded-full hover:bg-blue-700"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button></div>`;
                    document.getElementById('add-building-btn').onclick = () => showPage('page-form');
                    document.getElementById('settings-btn').onclick = () => showPage('page-settings');
                    searchBar.value = '';
                    ui.renderAdminList();
                } else if (pageId === 'page-form') {
                    headerActions.innerHTML = `<button id="save-btn" class="p-2 rounded-full hover:bg-blue-700"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></button>`;
                    document.getElementById('save-btn').onclick = handleFormSave;
                    form.reset();
                    state.photoCache = [];
                    let currentId;
                    if (params.buildingId) {
                        const building = db.getById(params.buildingId);
                        if (building) {
                            currentId = building.id;
                            for (const key in building) {
                                const element = document.getElementById(key);
                                if(element) {
                                    if (element.type === 'checkbox') { element.checked = building[key]; } 
                                    else { element.value = building[key]; }
                                }
                            }
                            document.getElementById('id').value = building.id; 
                            state.photoCache = [...(building.photos || [])];
                        }
                    } else {
                        currentId = db.uuid();
                        document.getElementById('id').value = currentId;
                    }
                    ui.renderFormQRCode(currentId);
                    ui.renderPhotoThumbnails();
                    document.querySelectorAll('#building-form input[type="number"]').forEach(input => {
                        const formattedEl = document.getElementById(`${input.id}-formatted`);
                        if (formattedEl) {
                             formattedEl.textContent = formatCurrency(input.value);
                        }
                    });
                } else if (pageId === 'page-detail') {
                    const building = db.getById(params.buildingId);
                    if (building) {
                        const fromAdmin = state.history.at(-1) === 'page-admin';
                        if (fromAdmin) {
                            headerActions.innerHTML = `<div class="flex items-center space-x-2"><button id="edit-btn" class="p-2 rounded-full hover:bg-blue-700"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg></button><button id="delete-btn" class="p-2 rounded-full hover:bg-red-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button></div>`;
                            document.getElementById('edit-btn').onclick = () => showPage('page-form', { buildingId: building.id });
                            document.getElementById('delete-btn').onclick = () => handleDelete(building.id);
                        }
                        ui.renderDetail(building, fromAdmin);
                    }
                } else if(pageId === 'page-scanner') {
                    startScanner();
                }
            };
            
            const goBack = () => { if (state.history.length > 0) { const pageToGoBackTo = state.history.pop(); showPage(pageToGoBackTo, {}, true); } };
            backButton.addEventListener('click', goBack);
            document.querySelectorAll('.nav-button').forEach(btn => btn.addEventListener('click', () => showPage(btn.dataset.target)));

            const handleFormSave = () => {
                if (!form.checkValidity()) { ui.showToast('toast_fill_fields', true); return; }
                const buildingData = {};
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if(input.id) {
                        if (input.type === 'checkbox') { buildingData[input.id] = input.checked; } 
                        else { buildingData[input.id] = input.value; }
                    }
                });
                buildingData.photos = state.photoCache;
                db.save(buildingData);
                ui.showToast('toast_saved');
                goBack();
            };

            const handleDelete = (id) => { if (confirm(translate('confirm_delete'))) { db.delete(id); ui.showToast('toast_deleted'); goBack(); } };
            
            const startScanner = () => {
                const html5QrCode = new Html5Qrcode("qr-reader");
                state.activeScanner = html5QrCode;
                const onScanSuccess = (decodedText, decodedResult) => {
                    if (state.activeScanner) {
                       state.activeScanner.stop().then(ignore => {
                            const building = db.getById(decodedText);
                            if (building) {
                                state.history.push('page-home');
                                showPage('page-detail', { buildingId: building.id });
                            } else {
                                ui.showToast('toast_qr_not_found', true);
                                goBack();
                            }
                        }).catch(err => console.error("Failed to stop scanner", err));
                       state.activeScanner = null;
                    }
                };
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess).catch(err => ui.showToast("toast_camera_fail", true));
            };
            
            getLocationBtn.addEventListener('click', () => {
                if ('geolocation' in navigator) {
                    navigator.geolocation.getCurrentPosition(position => {
                        document.getElementById('latitude').value = position.coords.latitude.toFixed(6);
                        document.getElementById('longitude').value = position.coords.longitude.toFixed(6);
                        ui.showToast('toast_location_captured');
                    }, error => ui.showToast('toast_location_fail', true));
                } else { ui.showToast('toast_geo_unsupported', true); }
            });

            const handlePhotoFiles = (files) => {
                if (!files || files.length === 0) return;
                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (e) => { state.photoCache.push(e.target.result); ui.renderPhotoThumbnails(); };
                    reader.readAsDataURL(file);
                });
            };
            photoUploadInput.addEventListener('change', (e) => handlePhotoFiles(e.target.files));
            photoCaptureInput.addEventListener('change', (e) => handlePhotoFiles(e.target.files));
            
            document.querySelectorAll('.stepper-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const targetInput = document.getElementById(btn.dataset.target);
                    let currentValue = parseInt(targetInput.value, 10);
                    if (btn.dataset.action === 'increment') {
                        currentValue++;
                    } else {
                        if (currentValue > 0) { currentValue--; }
                    }
                    targetInput.value = currentValue;
                });
            });

            const handleImport = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    let buildings = [];
                    try {
                        const fileExtension = file.name.split('.').pop().toLowerCase();
                        if (fileExtension === 'json') { buildings = JSON.parse(e.target.result); } 
                        else if (fileExtension === 'csv') { buildings = Papa.parse(e.target.result, { header: true, skipEmptyLines: true }).data; } 
                        else if (['xlsx', 'xls'].includes(fileExtension)) {
                            const workbook = XLSX.read(e.target.result, { type: 'binary' });
                            buildings = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                        } else { throw new Error('Unsupported file format.'); }
                        if (!Array.isArray(buildings)) throw new Error("Invalid file content.");
                        if (confirm(translate('confirm_import', {count: buildings.length}))) {
                            const sanitizedBuildings = buildings.map(b => sanitizeBuilding(b));
                            localStorage.setItem(DB_KEY, JSON.stringify(sanitizedBuildings));
                            ui.showToast('toast_imported', false, {count: sanitizedBuildings.length});
                            if(state.currentPage === 'page-admin') ui.renderAdminList(searchBar.value);
                        }
                    } catch (err) { ui.showToast('toast_import_fail', true); console.error(err); }
                };
                reader.readAsBinaryString(file);
                event.target.value = null;
            };
            
            const createAndDownloadFile = (filename, content, type) => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(new Blob([content], { type }));
                link.download = filename;
                link.click();
            };

            const handleExport = (format) => {
                const buildings = db.getAll();
                if (buildings.length === 0) { ui.showToast("toast_no_data_export", true); return; }
                const cleanBuildings = buildings.map(b => { const { photos, ...rest } = b; return rest; });
                if (format === 'json') { createAndDownloadFile('building_backup.json', JSON.stringify(buildings, null, 2), 'application/json'); } 
                else if (format === 'csv') { createAndDownloadFile('building_backup.csv', Papa.unparse(cleanBuildings), 'text/csv;charset=utf-8;'); } 
                else if (format === 'xlsx') {
                    const worksheet = XLSX.utils.json_to_sheet(cleanBuildings);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, "Buildings");
                    XLSX.writeFile(workbook, "building_backup.xlsx");
                }
                ui.showToast('toast_exported', false, {format: format.toUpperCase()});
            };

            document.getElementById('lang-switcher').addEventListener('click', () => {
                state.currentLang = state.currentLang === 'en' ? 'fa' : 'en';
                localStorage.setItem(LANG_KEY, state.currentLang);
                ui.updateText();
                // To refresh the current page with the new language
                const currentBuildingId = document.getElementById('id')?.value;
                showPage(state.currentPage, { buildingId: currentBuildingId }, true); 
            });
            
            document.querySelectorAll('#building-form input[type="number"]').forEach(input => {
                const formattedEl = document.getElementById(`${input.id}-formatted`);
                if (formattedEl) {
                    input.addEventListener('input', () => {
                        formattedEl.textContent = formatCurrency(input.value);
                    });
                }
            });

            // --- EVENT LISTENERS ---
            searchBar.addEventListener('input', (e) => {
                if (state.currentPage === 'page-admin') {
                    ui.renderAdminList(e.target.value);
                }
            });
            importFileInput.addEventListener('change', handleImport);
            importFileInputSettings.addEventListener('change', handleImport);
            exportJsonButton.addEventListener('click', () => handleExport('json'));
            exportCsvButton.addEventListener('click', () => handleExport('csv'));
            exportXlsxButton.addEventListener('click', () => handleExport('xlsx'));

            // --- INITIALIZATION ---
            ui.updateText();
            showPage('page-home');
        });
    </script>
</body>
</html>
