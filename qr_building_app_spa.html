<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline QR Building Information App</title>
    <!-- Chosen Palette: Warm Neutral (Slate, Stone, Sky Blue) -->
    <!-- Application Structure Plan: A task-oriented dashboard SPA. A persistent left-hand sidebar contains a searchable list of all building entries, acting as the primary navigation. The main content area on the right dynamically switches between views: a welcome screen, a detail/view screen for a selected building (which also shows the QR code), a form for adding/editing entries, a camera view for scanning, and a data management section. This structure was chosen to provide an efficient workflow, allowing users to quickly find, view, add, or scan information without navigating away from the main interface, directly reflecting the core tasks outlined in the source report. -->
    <!-- Visualization & Content Choices: Report Info: Storing and retrieving building data via QR codes. Goal: Create a functional management tool. Viz/Presentation Method: The core "visualization" is the QR code itself, generated on a canvas using qrcode.js. This method was chosen because the UID-based QR code is stable and efficient. Data is presented in interactive lists and forms. Interaction: Users can search the list, click to view details, generate/download QR codes, and use a live camera feed via html5-qrcode.js to scan codes, which triggers a lookup. Justification: This approach directly implements the proposal's core logic in a user-friendly, interactive manner without unnecessary complexity. No data charts are needed as the application's purpose is operational, not analytical. Library/Method: qrcode.js (generation), html5-qrcode.js (scanning). -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .view { display: none; }
        .view.active { display: block; }
        #qr-reader-container { position: relative; }
        #qr-reader-container #qr-reader { border: 2px solid #e5e7eb; border-radius: 0.5rem; }
        .sidebar-item:hover, .sidebar-item.selected { background-color: #e5e7eb; }
    </style>
</head>
<body class="bg-stone-50 text-slate-800">

    <div class="flex h-screen bg-stone-100">
        <!-- Sidebar -->
        <aside class="w-1/3 max-w-sm flex flex-col bg-white border-r border-stone-200">
            <div class="p-4 border-b border-stone-200">
                <h1 class="text-xl font-bold text-slate-900">Building Registry</h1>
                <p class="text-sm text-slate-500">Search, select, or add a building.</p>
                <input type="text" id="searchInput" placeholder="Search buildings..." class="mt-3 w-full px-3 py-2 text-sm bg-stone-50 border border-stone-300 rounded-md focus:outline-none focus:ring-2 focus:ring-sky-500">
            </div>
            <div id="buildingList" class="flex-grow overflow-y-auto">
                <!-- Building list items will be injected here by JS -->
            </div>
            <div class="p-4 border-t border-stone-200 space-y-2">
                <button id="addNewBtn" class="w-full bg-sky-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-sky-700 transition-colors">
                    &#43; Add New Building
                </button>
                 <button id="scanQRBtn" class="w-full bg-slate-700 text-white font-semibold py-2 px-4 rounded-md hover:bg-slate-800 transition-colors">
                    &#x1F4F7; Scan QR Code
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="w-2/3 flex-grow p-6 overflow-y-auto">
            <!-- Welcome View -->
            <div id="welcomeView" class="view active">
                <div class="bg-white p-8 rounded-lg shadow-sm border border-stone-200">
                    <h2 class="text-3xl font-bold text-slate-900">Welcome to the Building Information App</h2>
                    <p class="mt-2 text-slate-600">This application allows you to manage building information entirely offline. You can add new buildings, generate unique QR codes for them, and scan those codes to instantly retrieve details.</p>
                    <div class="mt-6 border-t border-stone-200 pt-6">
                        <h3 class="text-lg font-semibold">Getting Started:</h3>
                        <ul class="list-disc list-inside mt-2 space-y-1 text-slate-600">
                            <li>Click **"Add New Building"** to create your first entry.</li>
                            <li>Select a building from the list on the left to view its details and QR code.</li>
                            <li>Click **"Scan QR Code"** to use your camera to look up a building.</li>
                            <li>Use the **Import/Export** buttons below to back up or restore your data.</li>
                        </ul>
                    </div>
                     <div class="mt-6 flex gap-4">
                        <button id="exportBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 transition-colors">Export Data</button>
                        <button onclick="document.getElementById('importFile').click()" class="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-yellow-600 transition-colors">Import Data</button>
                        <input type="file" id="importFile" class="hidden" accept=".json">
                    </div>
                </div>
            </div>

            <!-- Detail View -->
            <div id="detailView" class="view">
                <div class="bg-white p-8 rounded-lg shadow-sm border border-stone-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 id="detailBuildingName" class="text-3xl font-bold text-slate-900"></h2>
                            <p id="detailLocationAddress" class="mt-1 text-slate-500"></p>
                        </div>
                        <button id="editBtn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-md hover:bg-slate-300 transition-colors">Edit</button>
                    </div>
                    <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-semibold border-b border-stone-200 pb-2 mb-3">Building Information</h3>
                            <div class="space-y-3 text-sm">
                                <p><strong>Construction Year:</strong> <span id="detailConstructionYear"></span></p>
                                <p><strong>Type/Usage:</strong> <span id="detailBuildingType"></span></p>
                                <div>
                                    <p><strong>Notes/Description:</strong></p>
                                    <p id="detailDescriptionNotes" class="mt-1 text-slate-600 whitespace-pre-wrap"></p>
                                </div>
                            </div>
                             <div id="detailCustomFields" class="mt-4 space-y-3 text-sm">
                                <!-- Custom fields will be injected here -->
                            </div>
                        </div>
                        <div class="flex flex-col items-center justify-center bg-stone-50 p-4 rounded-md">
                            <h3 class="text-lg font-semibold mb-2">Unique QR Code</h3>
                            <div id="detailQRCode" class="p-2 bg-white border border-stone-200 rounded-md"></div>
                            <button id="downloadQRBtn" class="mt-4 bg-sky-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-sky-700 transition-colors text-sm">Download QR Code</button>
                            <p class="text-xs text-slate-500 mt-2 text-center">Print and place this code on the building for quick scanning.</p>
                        </div>
                    </div>
                    <div class="mt-6 border-t border-stone-200 pt-4">
                        <button id="deleteBtn" class="text-red-600 hover:text-red-800 font-semibold transition-colors">Delete Building</button>
                    </div>
                </div>
            </div>

            <!-- Form View (for Add/Edit) -->
            <div id="formView" class="view">
                 <div class="bg-white p-8 rounded-lg shadow-sm border border-stone-200">
                    <h2 id="formTitle" class="text-3xl font-bold text-slate-900">Add New Building</h2>
                    <form id="buildingForm" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="hidden" id="buildingId">
                        <div class="md:col-span-2">
                            <label for="buildingName" class="block text-sm font-medium text-slate-700">Building Name</label>
                            <input type="text" id="buildingName" required class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                        </div>
                        <div class="md:col-span-2">
                            <label for="locationAddress" class="block text-sm font-medium text-slate-700">Location / Address</label>
                            <input type="text" id="locationAddress" class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                        </div>
                        <div>
                            <label for="constructionYear" class="block text-sm font-medium text-slate-700">Construction Year</label>
                            <input type="number" id="constructionYear" class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                        </div>
                        <div>
                            <label for="buildingType" class="block text-sm font-medium text-slate-700">Type / Usage</label>
                            <input type="text" id="buildingType" class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
                        </div>
                        <div class="md:col-span-2">
                            <label for="descriptionNotes" class="block text-sm font-medium text-slate-700">Notes / Description</label>
                            <textarea id="descriptionNotes" rows="4" class="mt-1 block w-full px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <h3 class="text-lg font-semibold mb-2">Custom Fields</h3>
                            <div id="customFieldsContainer" class="space-y-4"></div>
                            <button type="button" id="addCustomFieldBtn" class="mt-2 text-sm text-sky-600 font-semibold hover:text-sky-800">+ Add Custom Field</button>
                        </div>
                        <div class="md:col-span-2 flex items-center justify-end gap-4">
                            <button type="button" id="cancelBtn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-md hover:bg-slate-300">Cancel</button>
                            <button type="submit" class="bg-sky-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-sky-700">Save Building</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Scanner View -->
            <div id="scannerView" class="view">
                 <div class="bg-white p-8 rounded-lg shadow-sm border border-stone-200">
                    <h2 class="text-3xl font-bold text-slate-900">Scan QR Code</h2>
                    <p class="mt-2 text-slate-600">Point your camera at a building's QR code. The application will automatically detect it and display the building's information.</p>
                    <div id="qr-reader-container" class="mt-4 max-w-lg mx-auto">
                        <div id="qr-reader"></div>
                    </div>
                     <div class="mt-4 text-center">
                        <button id="closeScannerBtn" class="bg-slate-200 text-slate-800 font-semibold py-2 px-4 rounded-md hover:bg-slate-300">Close Scanner</button>
                    </div>
                </div>
            </div>

        </main>
    </div>
    
    <!-- Message Modal -->
    <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm text-center">
            <p id="modalMessageText"></p>
            <button id="modalCloseBtn" class="mt-4 bg-sky-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-sky-700 w-full">OK</button>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT ---
    let database = [];
    let currentView = 'welcomeView';
    let currentBuildingId = null;
    let html5QrCode = null;

    // --- DOM ELEMENTS ---
    const views = {
        welcome: document.getElementById('welcomeView'),
        detail: document.getElementById('detailView'),
        form: document.getElementById('formView'),
        scanner: document.getElementById('scannerView'),
    };
    const buildingListEl = document.getElementById('buildingList');
    const searchInput = document.getElementById('searchInput');
    const buildingForm = document.getElementById('buildingForm');
    const qrCodeEl = document.getElementById('detailQRCode');
    const customFieldsContainer = document.getElementById('customFieldsContainer');
    const messageModal = document.getElementById('messageModal');
    const modalMessageText = document.getElementById('modalMessageText');


    // --- INITIALIZATION ---
    loadDatabase();
    renderBuildingList();
    navigateTo('welcomeView');

    // --- DATA HANDLING ---
    function loadDatabase() {
        const savedData = localStorage.getItem('buildingDB');
        database = savedData ? JSON.parse(savedData) : [
            { id: 'BLDG-a8f5-4c9b-9d1e', buildingName: 'Central Tower', locationAddress: '123 Main St, Metropolis', constructionYear: 2010, buildingType: 'Commercial Office', descriptionNotes: 'Main headquarters. 50 floors.', customFields: [{key: 'Floors', value: '50'}] },
            { id: 'BLDG-b2c6-8d5f-1a3e', buildingName: 'Riverside Warehouse', locationAddress: '456 Industrial Ave, Star City', constructionYear: 1995, buildingType: 'Storage Facility', descriptionNotes: 'Primary distribution hub for the west coast.', customFields: [{key: 'Loading Docks', value: '12'}]}
        ];
        saveDatabase();
    }

    function saveDatabase() {
        localStorage.setItem('buildingDB', JSON.stringify(database));
    }
    
    function generateUUID() {
        return 'BLDG-' + crypto.randomUUID().slice(0, 18);
    }
    
    function showMessage(message) {
        modalMessageText.textContent = message;
        messageModal.classList.remove('hidden');
    }

    // --- RENDERING ---
    function renderBuildingList(filter = '') {
        buildingListEl.innerHTML = '';
        const filteredDB = database.filter(b => b.buildingName.toLowerCase().includes(filter.toLowerCase()));

        if (filteredDB.length === 0) {
            buildingListEl.innerHTML = `<p class="text-center text-slate-500 p-4">No buildings found.</p>`;
            return;
        }

        filteredDB.forEach(building => {
            const item = document.createElement('div');
            item.className = `p-4 border-b border-stone-200 cursor-pointer sidebar-item ${building.id === currentBuildingId ? 'selected' : ''}`;
            item.dataset.id = building.id;
            item.innerHTML = `
                <h3 class="font-semibold text-slate-800">${building.buildingName}</h3>
                <p class="text-sm text-slate-500">${building.locationAddress}</p>
            `;
            item.addEventListener('click', () => {
                currentBuildingId = building.id;
                renderBuildingList(searchInput.value); // Re-render to show selection
                populateDetailView(building.id);
                navigateTo('detail');
            });
            buildingListEl.appendChild(item);
        });
    }
    
    function populateDetailView(id) {
        const building = database.find(b => b.id === id);
        if (!building) return;

        document.getElementById('detailBuildingName').textContent = building.buildingName;
        document.getElementById('detailLocationAddress').textContent = building.locationAddress;
        document.getElementById('detailConstructionYear').textContent = building.constructionYear || 'N/A';
        document.getElementById('detailBuildingType').textContent = building.buildingType || 'N/A';
        document.getElementById('detailDescriptionNotes').textContent = building.descriptionNotes || 'No description provided.';
        
        const customFieldsEl = document.getElementById('detailCustomFields');
        customFieldsEl.innerHTML = '';
        if (building.customFields && building.customFields.length > 0) {
            const title = document.createElement('h4');
            title.className = 'font-semibold mb-2';
            title.textContent = 'Additional Details';
            customFieldsEl.appendChild(title);
            building.customFields.forEach(field => {
                const p = document.createElement('p');
                p.innerHTML = `<strong>${field.key}:</strong> <span>${field.value}</span>`;
                customFieldsEl.appendChild(p);
            });
        }

        generateQRCode(JSON.stringify({ buildingId: building.id }));
    }

    function populateFormForEdit(id) {
        const building = database.find(b => b.id === id);
        if (!building) return;

        document.getElementById('formTitle').textContent = 'Edit Building';
        document.getElementById('buildingId').value = building.id;
        document.getElementById('buildingName').value = building.buildingName;
        document.getElementById('locationAddress').value = building.locationAddress;
        document.getElementById('constructionYear').value = building.constructionYear;
        document.getElementById('buildingType').value = building.buildingType;
        document.getElementById('descriptionNotes').value = building.descriptionNotes;
        
        customFieldsContainer.innerHTML = '';
        if (building.customFields) {
            building.customFields.forEach(field => addCustomField(field.key, field.value));
        }
    }
    
    function resetForm() {
        document.getElementById('formTitle').textContent = 'Add New Building';
        buildingForm.reset();
        document.getElementById('buildingId').value = '';
        customFieldsContainer.innerHTML = '';
    }
    
    function addCustomField(key = '', value = '') {
        const fieldId = `custom-${Date.now()}`;
        const fieldDiv = document.createElement('div');
        fieldDiv.className = 'flex gap-2 items-center';
        fieldDiv.innerHTML = `
            <input type="text" placeholder="Field Name (e.g., Floors)" value="${key}" class="key-input mt-1 block w-1/2 px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
            <input type="text" placeholder="Value (e.g., 10)" value="${value}" class="value-input mt-1 block w-1/2 px-3 py-2 bg-white border border-stone-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500">
            <button type="button" class="remove-field-btn text-red-500 hover:text-red-700 font-bold text-lg">&times;</button>
        `;
        customFieldsContainer.appendChild(fieldDiv);

        fieldDiv.querySelector('.remove-field-btn').addEventListener('click', () => {
            fieldDiv.remove();
        });
    }


    // --- NAVIGATION ---
    function navigateTo(viewName) {
        currentView = viewName;
        Object.values(views).forEach(v => v.classList.remove('active'));
        if (views[viewName]) {
            views[viewName].classList.add('active');
        }

        // Stop scanner when navigating away
        if (viewName !== 'scanner' && html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().catch(err => console.error("Failed to stop QR scanner:", err));
        }
    }

    // --- QR CODE HANDLING ---
    function generateQRCode(text) {
        qrCodeEl.innerHTML = '';
        new QRCode(qrCodeEl, {
            text: text,
            width: 180,
            height: 180,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });
    }

    function startScanner() {
        navigateTo('scanner');
        html5QrCode = new Html5Qrcode("qr-reader");
        const qrCodeSuccessCallback = (decodedText, decodedResult) => {
            try {
                const data = JSON.parse(decodedText);
                if (data.buildingId) {
                    const building = database.find(b => b.id === data.buildingId);
                    if (building) {
                        currentBuildingId = building.id;
                        populateDetailView(building.id);
                        navigateTo('detail');
                        renderBuildingList(searchInput.value);
                        showMessage(`Success! Found: ${building.buildingName}`);
                    } else {
                        showMessage(`Error: Building with ID ${data.buildingId} not found in the local database.`);
                        navigateTo('welcome');
                    }
                }
            } catch (e) {
                showMessage(`Error: Scanned QR code does not contain valid building data.`);
                console.error("QR scan parse error:", e);
                navigateTo('welcome');
            }
        };
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
            .catch(err => {
                showMessage("Unable to start QR scanner. Please ensure you have a camera and have granted permission.");
                console.error("QR Scanner Error:", err);
                navigateTo('welcome');
            });
    }
    
    // --- EVENT LISTENERS ---
    searchInput.addEventListener('input', (e) => renderBuildingList(e.target.value));

    document.getElementById('addNewBtn').addEventListener('click', () => {
        currentBuildingId = null;
        resetForm();
        navigateTo('form');
    });

    document.getElementById('editBtn').addEventListener('click', () => {
        if (currentBuildingId) {
            populateFormForEdit(currentBuildingId);
            navigateTo('form');
        }
    });

    document.getElementById('cancelBtn').addEventListener('click', () => {
        if (currentBuildingId) {
            populateDetailView(currentBuildingId);
            navigateTo('detail');
        } else {
            navigateTo('welcome');
        }
    });
    
    document.getElementById('addCustomFieldBtn').addEventListener('click', () => addCustomField());

    buildingForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('buildingId').value;
        const customFields = [];
        document.querySelectorAll('#customFieldsContainer .flex').forEach(fieldDiv => {
            const key = fieldDiv.querySelector('.key-input').value.trim();
            const value = fieldDiv.querySelector('.value-input').value.trim();
            if (key && value) {
                customFields.push({ key, value });
            }
        });

        const buildingData = {
            buildingName: document.getElementById('buildingName').value,
            locationAddress: document.getElementById('locationAddress').value,
            constructionYear: document.getElementById('constructionYear').value,
            buildingType: document.getElementById('buildingType').value,
            descriptionNotes: document.getElementById('descriptionNotes').value,
            customFields: customFields
        };

        if (id) { // Editing existing
            const index = database.findIndex(b => b.id === id);
            database[index] = { ...database[index], ...buildingData };
        } else { // Adding new
            buildingData.id = generateUUID();
            database.unshift(buildingData);
        }
        
        saveDatabase();
        currentBuildingId = id || buildingData.id;
        renderBuildingList();
        populateDetailView(currentBuildingId);
        navigateTo('detail');
    });
    
    document.getElementById('deleteBtn').addEventListener('click', () => {
        if (currentBuildingId && confirm('Are you sure you want to delete this building? This action cannot be undone.')) {
            database = database.filter(b => b.id !== currentBuildingId);
            saveDatabase();
            currentBuildingId = null;
            renderBuildingList();
            navigateTo('welcome');
        }
    });

    document.getElementById('downloadQRBtn').addEventListener('click', () => {
        const canvas = qrCodeEl.querySelector('canvas');
        const link = document.createElement('a');
        link.download = `qr-code-${currentBuildingId}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
    });

    document.getElementById('scanQRBtn').addEventListener('click', startScanner);
    document.getElementById('closeScannerBtn').addEventListener('click', () => navigateTo('welcome'));

    document.getElementById('exportBtn').addEventListener('click', () => {
        const dataStr = JSON.stringify(database, null, 2);
        const dataBlob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.download = `building-data-backup-${new Date().toISOString().slice(0,10)}.json`;
        link.href = url;
        link.click();
        URL.revokeObjectURL(url);
        showMessage("Data exported successfully!");
    });
    
    document.getElementById('importFile').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (Array.isArray(importedData)) {
                     if (confirm('Are you sure you want to overwrite your current data with the imported file? This cannot be undone.')) {
                        database = importedData;
                        saveDatabase();
                        renderBuildingList();
                        navigateTo('welcome');
                        showMessage("Data imported successfully!");
                    }
                } else {
                   showMessage("Import failed: Invalid file format.");
                }
            } catch (error) {
                showMessage("Import failed: Could not parse the file.");
                console.error("Import error:", error);
            }
        };
        reader.readAsText(file);
        event.target.value = ''; // Reset file input
    });
    
    document.getElementById('modalCloseBtn').addEventListener('click', () => {
        messageModal.classList.add('hidden');
    });

});
</script>
</body>
</html>
